# Ch08

# âœ³ 0. Message Queue

---

## Message Queue ë€ ë¬´ì—‡ì¸ê°€??

- ë©”ì‹œì§€ ì§€í–¥ ë¯¸ë“¤ì›¨ì–´(Meesage Oriented Middleware: MOM)ì€ ë¹„ë™ê¸° ë©”ì‹œì§€ë¥¼ ì‚¬ìš©í•˜ëŠ” ë‹¤ë¥¸ ì‘ìš© í”„ë¡œê·¸ë¨ ì‚¬ì´ì—ì„œ ë°ì´í„° ì†¡ìˆ˜ì‹ ì„ ì˜ë¯¸
    - ë©”ì‹œì§€ë¥¼ í†µí•´ ì—¬ëŸ¬ ë¶„ì‚°ë˜ì–´ ìˆëŠ” ì‹œìŠ¤í…œ ê°„ì˜ Connector ì—­í• ë¡œ ê²°í•©ì„±ì„ ë‚®ì¶”ê³ , ì´ë“¤ì´ ì„œë¡œ ì‹¤ì‹œê°„ ë¹„ë™ê¸°ì‹ ë°ì´í„°ë¥¼ êµí™˜í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ì†Œí”„íŠ¸ì›¨ì–´        
- MOMì„ êµ¬í˜„í•œ ì‹œìŠ¤í…œì„ ë©”ì‹œì§€ í(MessageQueue: MQ)ë¼ í•¨
- Producer(sender) ê°€ ë©”ì‹œì§€ë¥¼ íì— ì „ì†¡í•˜ë©´ Consumer(receiver) ê°€ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ, producer ì™€ consumer ì— message í”„ë¡œì„¸ìŠ¤ê°€ ì¶”ê°€ë˜ëŠ” ê²ƒì´ íŠ¹ì§•

### **ë©”ì‹œì§€ íì˜ ì¥ì **

- ë¹„ë™ê¸°(Asynchronous): Queueì— ë„£ê¸° ë•Œë¬¸ì— ë‚˜ì¤‘ì— ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.
- ë¹„ë™ì¡°(Decoupling): ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ ë¶„ë¦¬í•  ìˆ˜ ìˆë‹¤.
- íƒ„ë ¥ì„±(Resilience): ì¼ë¶€ê°€ ì‹¤íŒ¨ ì‹œ ì „ì²´ì— ì˜í–¥ì„ ë°›ì§€ ì•ŠëŠ”ë‹¤.
- ê³¼ì‰(Redundancy): ì‹¤íŒ¨í•  ê²½ìš° ì¬ì‹¤í–‰ ê°€ëŠ¥í•˜ë‹¤.
- ë³´ì¦(Guarantees): ì‘ì—…ì´ ì²˜ë¦¬ëœê±¸ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
- í™•ì¥ì„±(Scalable): ë‹¤ìˆ˜ì˜ í”„ë¡œì„¸ìŠ¤ë“¤ì´ íì— ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆë‹¤.

### ë©”ì‹œì§€ í ì¢…ë¥˜

Apache ActiveMQ, RabbitMQ, Apache Kafka, Apache Qpid, Apache RocketMQ, JBoss Messaging ë“±

### Apache ActiveMQ

- Java Message Service (JMS)ë¥¼ ì‚¬ìš©í•˜ëŠ” ì˜¤í”ˆì†ŒìŠ¤ MQ
- Java, C, C ++, C #, Ruby, Perl, Python, PHP ë“± ë‹¤ì–‘í•œ í¬ë¡œìŠ¤ ì–¸ì–´ í´ë¼ì´ì–¸íŠ¸ ë° í”„ë¡œí† ì½œ ì§€ì›
- Spring ì§€ì›ìœ¼ë¡œ Spring xml config ë©”ì»¤ë‹ˆì¦˜ ì´ìš© ê°€ëŠ¥
- JDBC ì§€ì›ìœ¼ë¡œ DB ë†’ì€ í¼í¬ë¨¼ìŠ¤ ê°€ëŠ¥
- ë†’ì€ í¼í¬ë¨¼ìŠ¤ë¥¼ ìœ„í•´ í´ëŸ¬ìŠ¤í„°ë§ êµ¬ì„± ê°€ëŠ¥
- Restful API ì œê³µ
- ë‹¨ ëª¨ë‹ˆí„°ë§ ë„êµ¬ì œê³µí•˜ì§€ ì•ŠìŒ

### RabbitMQ

- ê³ ì„±ëŠ¥ì„ ëª©í‘œë¡œ AMQP í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ì—¬ ê°œë°œëœ MQ
- ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ì´ ìš©ì´
- ë‹¤ì–‘í•œ ì–¸ì–´ ë° OS ì§€ì›
- RabbitMQ ì„œë²„ê°„ í´ëŸ¬ìŠ¤í„°ë§ì´ ê°€ëŠ¥
- ì‹ ë¢°ì„±,Â ì•ˆì •ì„±ê³¼ ì„±ëŠ¥ì„ ì¶©ì¡±í•  ìˆ˜ ìˆë„ë¡ ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ì œê³µ
- ë‹¨ Window OS ì‹œ, Erlang, OpenSSL ì„¤ì¹˜ í•„ìš”

### Kafka

- ëŒ€ìš©ëŸ‰ ì‹¤ì‹œê°„ ë¡œê·¸ ì²˜ë¦¬ì— íŠ¹í™”ë˜ì–´ ì„¤ê³„ëœ ë©”ì‹œì§€ ì‹œìŠ¤í…œ
- ê¸°ì¡´ ë²”ìš© ë©”ì‹œì§• ì‹œìŠ¤í…œëŒ€ë¹„ TPSê°€ ë§¤ìš° ìš°ìˆ˜
    - TPS: Transaction per Second
- AMQPë‚˜ JMSë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ë‹¨ìˆœ ë©”ì‹œì§€ í—¤ë”ë¥¼ ì§€ë‹Œ TCP í†µì‹ ì„ ì‚¬ìš©í•˜ì—¬ **í”„ë¡œí† ì½œì— ì˜í•œ ì˜¤ë²„í—¤ë“œ ê°ì†Œ**
- MQëŠ” brokerê°€ producer ì—ê²Œ ë©”ì„¸ì§€ë¥¼ ë°›ì•„ì„œ consumerì—ê²Œ pushí•´ ì£¼ëŠ” ë°©ì‹ì¸ë° ë°˜í•´, KafkaëŠ” consumerê°€ brokerë¡œë¶€í„° ì§ì ‘ ë©”ì‹œì§€ë¥¼ ê°€ì§€ê³  ê°€ëŠ” **pull ë°©ì‹**ìœ¼ë¡œ ë™ì‘ : Consumer ì‚¬ì–‘ì— ë”°ë¼ í¼í¬ë¨¼ìŠ¤ê°€ ë‹¬ë¼ì§
- ë©”ì‹œì§€ë¥¼ ê¸°ë³¸ì ìœ¼ë¡œ ë©”ëª¨ë¦¬ì— ì €ì¥í•˜ëŠ” ê¸°ì¡´ ë©”ì‹œì§• ì‹œìŠ¤í…œê³¼ëŠ” ë‹¬ë¦¬ ë©”ì‹œì§€ë¥¼ íŒŒì¼ ì‹œìŠ¤í…œì— ì €ì¥
    - ëŒ€ê¸° ì¤‘ ì¸ ë©”ì‹œì§€ë¡œ ì¸í•œ ì‹œìŠ¤í…œ ì„±ëŠ¥ê°ì†Œ ìµœì†Œí™”
- ê°œë³„ ì „ì†¡ì´ ì•„ë‹Œ ë‹¤ìˆ˜ ì „ì†¡ ê°€ëŠ¥ (Batch ì²˜ë¦¬ ê°€ëŠ¥)
- ë‹¨ íŠ¹í™”ëœ ì†”ë£¨ì…˜ì´ê¸° ë•Œë¬¸ì— **íƒ€ MQ ì†”ë£¨ì…˜ì—ì„œ ì œê³µí•˜ëŠ” ë‹¤ì–‘í•œ ê¸°ëŠ¥ë“¤ì€ ì œê³µë˜ì§€ ì•ŠìŒ**

# ğŸ“˜ 1. JMSë¡œ ë©”ì‹œì§€ ì „ì†¡í•˜ê¸°

---

JMSë€, ë‘ê°œ ì´ìƒì˜ í´ë¼ì´ì–¸íŠ¸ ê°„ì— ë©”ì‹œì§€ í†µì‹ ì„ ìœ„í•œ ê³µí†µ APIë¥¼ ì •ì˜í•˜ëŠ” ìë°” í‘œì¤€ì´ë‹¤.

ìŠ¤í”„ë§ì€ JmsTemplateì´ë¼ëŠ” í…œí”Œë¦¿ ê¸°ë°˜ì˜ í´ë˜ìŠ¤ë¥¼ í†µí•´ JMSë¥¼ ì§€ì›í•œë‹¤.

JmsTeamplateì„ ì‚¬ìš©í•˜ë©´ í”„ë¡œë“€ì„œê°€ íì™€ í† í”½ì— ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ê³  ConsumerëŠ” ê·¸ í† ë©”ì‹œì§€ë“¤ì„ ë°›ì„ ìˆ˜ ìˆë‹¤.

ë˜í•œ ìŠ¤í”„ë§ ë©”ì‹œì§€ ê¸°ë°˜ì˜ POJOë„ ì§€ì›í•œë‹¤. POJOëŠ” íë‚˜ í† í”½ì— ë„ì°©í•˜ëŠ” ë©”ì‹œì§€ì— ë°˜ì‘í•˜ì—¬ ë¹„ë™ê¸° ë°©ì‹ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ëŠ” ê°„ë‹¨í•œ Java ê°ì²´ì´ë‹¤.

ë©”ì‹œì§€ë¥¼ ì „ì†¡/ìˆ˜ì‹ í•˜ê¸° ìœ„í•´ì„œëŠ” Producer/Consumer ê°„ì— ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•´ì£¼ëŠ” ë©”ì‹œì§€ ë¸Œë¡œì»¤ê°€ ì¡´ì¬í•´ì•¼í•œë‹¤.

# 1.1. JMS ì„¤ì •í•˜ê¸° (Artemis)

JMSë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” Brokerë¥¼ ì„¤ì •í•´ì•¼í•˜ëŠ”ë°, ì—¬ê¸°ì„œëŠ” ActiveMQ Artemis ì¤‘ì—ì„œ ì„ íƒí•˜ì—¬ ì˜ì¡´ì„±ì„ ì¶”ê°€í•œë‹¤. 

ê¸°ë³¸ì ìœ¼ë¡œ Springì€ Artemis ë¸Œë¡œì»¤ê°€ [localhost](http://localhost) 61616 í¬íŠ¸ë¥¼ ë¦¬ìŠ¤ë‹í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°„ì£¼í•˜ì§€ë§Œ, ì‹¤ë¬´ í™˜ê²½ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ëª‡ ê°€ì§€ ì¶”ê°€ ì„¤ì •ì„ í•´ì•¼í•œë‹¤.

### **Artemis ë¸Œë¡œì»¤ì˜ ìœ„ì¹˜ì™€ ì¸ì¦ ì •ë³´ë¥¼ êµ¬ì„±í•˜ëŠ” ì†ì„±**
|ì†ì„±|ì„¤ëª…|
|:--:|:--:|
|spring.artemis.boot|ë¸Œë¡œì»¤ì˜ í˜¸ìŠ¤íŠ¸|
|spring.artemis.port|ë¸Œë¡œì»¤ì˜ í¬íŠ¸|
|spring.artemis.user|ë¸Œë¡œì»¤ë¥¼ ì‚¬ìš”í•˜ê¸° ìœ„í•œ ì‚¬ìš©ì(ì„ íƒì†ì„±)|
|spring.artemis.password|ë¸Œë¡œì»¤ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì‚¬ìš©ì ì•”í˜¸(ì„ íƒì†ì„±)|

- ActiveMQëŠ” ìƒëµí•©ë‹ˆë‹¤.
- ì ìš© ì˜ˆì‹œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

**application.yml**

```java
spring:
	artemis:
		host: artemis.tacocloud.com
		port:61617
		user: tacoweb
		password: 123456
```

# 1.2. JmsTemplateì„ ì‚¬ìš©í•´ì„œ ë©”ì‹œì§€ ì „ì†¡í•˜ê¸°

JMS ìŠ¤íƒ€í„° ì˜ì¡´ì„±ì„ ì£¼ì…í•˜ë©´, JmsTemplateì„ ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ìë™-êµ¬ì„±í•œë‹¤. JmsTemplateì€ ë©”ì‹œì§€ ë¸Œë¡œì»¤ì™€ì˜ ì—°ê²°, ì„¸ì…˜ ìƒì„± ì½”ë“œ, ì˜ˆì™¸ì²˜ë¦¬ ë“±ì„ ìˆ˜í–‰í•œë‹¤. ë”°ë¼ì„œ, ë©”ì‹œì§€ ì „ì†¡ì—ë§Œ ì§‘ì¤‘í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.

**JmsTemplateì˜ ë©”ì‹œì§€ ì „ì†¡ì— ì‚¬ìš©ë˜ëŠ” ë©”ì„œë“œ**

```java
// 1. ì›ì‹œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•œë‹¤.
// Message ê°ì²´ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ MessageCreatorë¥¼ í•„ìš”ë¡œí•œë‹¤.
void send(MessageCreator message)throws JmsException;
void send(Destination destination, MessageCreator messageCreator) throws JmsException;
void send(String destinationName, MessageCreator messageCreator) throws JmsException;

// 2. ê°ì²´ë¡œë¶€í„° ë³€í™˜ëœ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•œë‹¤.
// ì¤‘ê°„ì˜ Object íƒ€ì… ê°ì²´ë¥¼ ì¸ìë¡œ ë°›ì•„ ë‚´ë¶€ì ìœ¼ë¡œ Message íƒ€ì…ìœ¼ë¡œ ë³€í™˜í•œë‹¤.
void covnertAndSend(Object message) throws JmsException;
void covnertAndSend(Destination destination, Object message) throws JmsException;
void covnertAndSend(String destinationName, MessageCreator messageCreator) throws JmsException;

// 3. ê°ì²´ë¡œë¶€í„° ë³€í™˜ë˜ê³  ì „ì†¡ì— ì•ì„œ í›„ì²˜ë¦¬ë˜ëŠ” ë©”ì‹œì§€ë¥¼ ì „ì†¡í•œë‹¤.
// Object íƒ€ì… ê°ì²´ë¥¼ Messsage íƒ€ì…ìœ¼ë¡œ ë³€í™˜í•œë‹¤. ê·¸ëŸ¬ë‚˜ ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ê¸° ì „ì— Messageì˜ ì»¤ìŠ¤í„°ë§ˆì´ì§•ì„ í•  ìˆ˜ ìˆë„ë¡ MessagePostProcessorë„ ì¸ìë¡œ ë°›ëŠ”ë‹¤.
void convertAndSend(Object message, MessagePostProcessor postProcessor) throws JmsException;
void convertAndSend(Destination destination, Object message, MessagePostProecessor postProcessor) throws JmsException;
void convertAndSend(String destinationName, Object message, MessagePostProcessor postProcessor) throws JmsException;
```

ìœ„ë¥¼ ë³´ë©´ ì•Œ ìˆ˜ ìˆë“¯ì´, ì‹¤ì œë¡œëŠ” `send()`ì™€ `convertAndSend()` ì˜ ë‘ ê°œì˜ ë©”ì†Œë“œë§Œ ìˆìœ¼ë©°, ê° ë©”ì†Œë“œëŠ” ì„œë¡œ ë‹¤ë¥¸ ë§¤ê°œë³€ìˆ˜ë¥¼ ì§€ì›í•˜ê¸° ìœ„í•´ ì˜¤ë²„ë¡œë”©ë˜ì–´ ìˆë‹¤.

ì´ë“¤ 3ê°œì˜ ë©”ì„œë“œ ë¶€ë¥˜ ê°ê°ì€ 3ê°œì˜ ì˜¤ë²„ë¡œë”©ëœ ë©”ì†Œë“œë¡œ êµ¬ì„±ë˜ë©°, ì´ ë©”ì†Œë“œë“¤ì€ JMS ë©”ì‹œì§€ì˜ ë„ì°©ì§€, ì¦‰ ë©”ì‹œì§€ë¥¼ ì“°ëŠ”ê³³ì„ ì§€ì •í•˜ëŠ” ë°©ë²•ì´ ë‹¤ë¥´ë‹¤.

**JMS ë©”ì‹œì§€ì˜ ë„ì°©ì§€ ì§€ì • ë°©ë²•**

1. ë„ì°©ì§€ ë§¤ê°œë³€ìˆ˜ê°€ ì—†ìœ¼ë©°, í•´ë‹¹ ë©”ì‹œì§€ë¥¼ ê¸°ë³¸ ë„ì°©ì§€ë¡œ ì „ì†¡í•œë‹¤.
2. ë©”ì‹œì§€ì˜ ë„ì°©ì§€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” Destination ê°ì²´ë¥¼ ì¸ìë¡œ ë°›ëŠ”ë‹¤.
3. ë©”ì‹œì§€ì˜ ë„ì°©ì§€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ë¬¸ìì—´ì„ ì¸ìë¡œ ë°›ëŠ”ë‹¤.

### 1.2.#. `send()`ì˜ ì‚¬ìš©ì˜ˆ

**1) ìµëª…í•¨ìˆ˜ ì‚¬ìš©**

```java
@Service
public class JmsOrderMessagingService implements OrderMessagingService{
    private JmsTemplate jms;

    @Autowired
    public JmsOrderMessagingService(JmsTemplate jms){
        this.jms=jms;
    }

    @Override
    public void sendOrder(Order order){
        jms.send(new MessageCreator(){
            @Override
            public Message createMessage(Session session) throws JMSException{
                return session.createObjectMessage(order);
            }
        });
    }
}
```

sendOrder() ë©”ì„œë“œì—ì„œëŠ” MessageCreator ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ ìµëª…ì˜ ë‚´ë¶€ í´ë˜ìŠ¤ë¥¼ ì¸ìë¡œ ì „ë‹¬í•˜ì—¬ jms.send()ë¥¼ í˜¸ì¶œí•œë‹¤.

ê·¸ë¦¬ê³  ìµëª…ì˜ ë‚´ë¶€í´ë˜ìŠ¤ëŠ” createMessage()ë¥¼ ì˜¤ë²„ë¼ì´ë”©í•˜ì—¬ ì „ë‹¬ëœ Order ê°ì²´ë¡œë¶€í„° ìƒˆë¡œìš´ ë©”ì‹œì§€ë¥¼ ìƒì„±í•œë‹¤.

**2) ëŒë‹¤ì‹ ì‚¬ìš©**

```java
@Override
public void sendOrder(Order order){
    jms.send(session -> session.createObjectMessage(order));
}
```

### **#. ê¸°ë³¸ ë„ì°©ì§€ ì§€ì •í•˜ê¸°**

sendOrder() ë©”ì†Œë“œëŠ” ë©”ì‹œì§€ì˜ ë„ì°©ì§€ë¥¼ ì§€ì •í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ê¸°ë³¸ ë„ì°©ì§€ì˜ ì´ë¦„ì„ ì§€ì •í•´ì•¼í•œë‹¤.

ë‹¤ìŒì˜ ì˜ˆì‹œì™€ ê°™ì´ `spring.jms.template.default-destination` ì†ì„±ì— ì§€ì •í•´ì•¼í•œë‹¤.

**application.yml**

```java
spring:
  jms:
    template:
      default-destination: tacocloud.order.queue
```

ìœ„ ì²˜ëŸ¼ ê¸°ë³¸ ë„ì°©ì§€ ì´ë¦„ì„ í•œ ë²ˆë§Œ ì§€ì •í•˜ë©´ ì½”ë“œì—ì„œëŠ” ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ëŠ” ê³³ì„ ì‹ ê²½ì“°ì§€ ì•Šê³  ì „ì†¡í•˜ëŠ” ê²ƒì—ë§Œ ì§‘ì¤‘í•  ìˆ˜ ìˆë‹¤.

### **#. ì»¤ìŠ¤í…€ ë„ì°©ì§€ ì§€ì •í•˜ê¸°**

ê·¸ëŸ¬ë‚˜, ê¸°ë³¸ ë„ì°©ì§€ê°€ ì•„ë‹Œ ë‹¤ë¥¸ê³³ì— ë©”ì‹œì§€ë¥¼ ì „ì†¡í•´ì•¼ í•œë‹¤ë©´ `send()` ë©”ì†Œë“œì˜ ë§¤ê°œë³€ìˆ˜ë¡œ ë„ì°©ì§€ë¥¼ ì„¤ì •í•´ì•¼í•œë‹¤.

send()ì˜ ì²« ë²ˆì§¸ ë§¤ê°œë³€ìˆ˜ë¡œ Destination ê°ì²´ë¥¼ ì „ë‹¬í•œë‹¤. ì•„ ê²½ìš°ì—ëŠ” Destination ë¹ˆì„ ì„ ì–¸í•˜ê³  ë©”ì‹œì§€ ì „ì†¡ì„ ìˆ˜í–‰í•˜ëŠ” ë¹ˆì— ì£¼ì…í•˜ë©´ ëœë‹¤.

ì˜ˆë¥¼ ë“¤ë©´, ë‹¤ìŒ ë¹ˆì—ì„œëŠ” íƒ€ì½” í´ë¼ìš°ë“œì˜ ì£¼ë¬¸ í(ì£¼ë¬¸ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ”)ë¥¼ Destination ë¹ˆìœ¼ë¡œ ì„ ì–¸í•œë‹¤.

```java
@Bean
public Destination orderQueue(){
    return new ActiveMQQueue("tacocloud.order.queue"); // ActiveMQQueue: Artemisì˜ í´ë˜ìŠ¤
}
```

ìœ„ Destination ë¹ˆì´ JmsOrderMessagingServiceì— ì£¼ì…ë˜ë©´ send()ë¥¼ í˜¸ì¶œí•  ë•Œì— ì´ ë¹ˆì„ ì‚¬ìš©í•˜ì—¬ ë©”ì‹œì§€ ë„ì°©ì§€ë¥¼ ì§€ì •í•  ìˆ˜ ìˆë‹¤.

**Destination ë¹ˆì„ ì‚¬ìš©í•˜ì—¬ ë©”ì‹œì§€ ë„ì°©ì§€ë¥¼ ì§€ì •**

```java
private Destination orderQueue;  // <= ìœ„ì˜ orderQueue ë©”ì†Œë“œ

@Autowired
public JmsOrderMessagingService(JmsTemplate jms, Destination orderQueue){
    this.jms=jms;
    this.orederQueue=orderQueue;
}
...

@Override
public void sendOrder(Order order){
    jms.send(
        orderQueue,   // <= Destination ê°ì²´ë¥¼ ì‚¬ìš©í•´ ë©”ì‹œì§€ ë„ì°©ì§€ë¥¼ ì§€ì •í•˜ë©´ ë„ì°©ì§€ ì´ë¦„ë§Œ ì§€ì •í•˜ëŠ” ê²ƒë³´ë‹¤ ë” ë‹¤ì–‘í•˜ê²Œ ë„ì°©ì§€ êµ¬ì„± ê°€ëŠ¥
        session -> session.createObjectMessage(order) 
    );
}
```

ì´ì™€ ê°™ì´ Destination ê°ì²´ë¥¼ ì‚¬ìš©í•´ ë©”ì‹œì§€ ë„ì°©ì§€ë¥¼ ì§€ì •í•˜ë©´ ë„ì°©ì§€ ì´ë¦„ë§Œ ì§€ì •í•˜ëŠ” ê²ƒë³´ë‹¤ ë” ë‹¤ì–‘í•˜ê²Œ ë„ì°©ì§€ë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆë‹¤.

ê·¸ëŸ¬ë‚˜ ì‹¤ì œë¡œëŠ” ë„ì°©ì§€ ì´ë¦„ ì™¸ì— ë‹¤ë¥¸ê²ƒì„ ì§€ì •í•˜ëŠ” ì¼ì€ ê±°ì˜ ì—†ìœ¼ë¯€ë¡œ `send()`ì˜ ì²« ë²ˆì§¸ ì¸ìë¡œ Destinationê°ì²´ ëŒ€ì‹  **ë„ì°©ì§€ ì´ë¦„ë§Œ ì§€ì •**í•˜ëŠ”ê²Œ ë” ì‰½ë‹¤.

**ë„ì°©ì§€ ì´ë¦„ë§Œ ì§€ì •**

```java
@Override
public void sendOrder(Order order){
    jms.send(
        "tacocloud.order.queue",  // <= ë„ì°©ì§€ ì´ë¦„ë§Œ ì§€ì •
        session -> session.createObjectMessage(order)
    );
}
```

send()ë©”ì†Œë“œì˜ ì‚¬ìš©ì€ ì–´ë µì§€ì•Šì§€ë§Œ Messageê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” MessageCreatorë¥¼ ë‘ ë²ˆì§¸ ì¸ìë¡œ ì „ë‹¬í•´ì•¼ í•˜ë¯€ë¡œ ì½”ë“œê°€ ì¡°ê¸ˆ ë³µì¡í•´ì§„ë‹¤.

ë”°ë¼ì„œ ì „ì†¡í•  ë©”ì‹œì§€ ê°ì²´ë§Œ ì§€ì •í•  ìˆ˜ ìˆë‹¤ë©´ ë”ê°„ë‹¨í•´ì§ˆê²ƒì¸ë° convertAndSend()ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

---

### **#. ë©”ì‹œì§€ ë³€í™˜í•˜ê³  ì „ì†¡í•˜ê¸°**

JmsTemplateì˜ `convertAndSend()` ë©”ì„œë“œëŠ” MessageCreatorë¥¼ ì œê³µí•˜ì§€ ì•Šì•„ë„ ë˜ë¯€ë¡œ ë©”ì‹œì§€ ì „ì†¡ì´ ê°„ë‹¨í•˜ë‹¤. 

convertAndSend()ì˜ ì¸ìë¡œ ì§ì ‘ ì „ë‹¬í•˜ë©´ í•´ë‹¹ ê°ì²´ê°€ Message ê°ì²´ë¡œ ë³€í™˜ë˜ì–´ ì „ì†¡ëœë‹¤.

ë‹¤ìŒê³¼ ê°™ì´ ì¬ êµ¬í˜„í•œ sendOrder()ì—ì„œëŠ” convertAndSend()ë¥¼ ì‚¬ìš©í•´ì„œ Orderê°ì²´ë¥¼ ì§€ì •ëœ ë„ì°©ì§€ë¡œ ì „ì†¡í•œë‹¤.

```java
@Override
public void sendOrder(Order order){
    jms.convertAndSend("tacocloud.order.queue",order);
}
```

- send() ë©”ì†Œë“œì²˜ëŸ¼ convertAndSend()ëŠ” Destination ê°ì²´ë‚˜ ë¬¸ìì—´ ê°’ìœ¼ë¡œ ì§€ì •í•œ ë„ì°©ì§€ë¥¼ ì¸ìë¡œ ë°›ëŠ”ë‹¤.
- ë˜ëŠ” ë„ì°©ì§€ë¥¼ ìƒëµí•˜ì—¬ ê¸°ë³¸ ë„ì°©ì§€ë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆë‹¤.
- convertAndSend()ë¥¼ ì‚¬ìš©í•˜ë©´ ì¸ìë¡œ ì „ë‹¬ë˜ëŠ” Order ê°ì²´ëŠ” Message ê°ì²´ë¡œ ë³€í™˜ëœ í›„ ì „ì†¡ëœë‹¤.

### **#. ë©”ì‹œì§€ ë³€í™˜ê¸° êµ¬í˜„í•˜ê¸°**

MessageConverterëŠ” ìŠ¤í”„ë§ì— ì •ì˜ëœ ì¸í„°í˜ì´ìŠ¤ì´ë©°, 2ê°œì˜ ë©”ì†Œë“œë§Œ ì •ì˜ë˜ì–´ ìˆë‹¤.

ìŠ¤í”„ë§ì— êµ¬í˜„ë˜ì–´ìˆê¸° ë•Œë¬¸ì— ì´ëŠ” êµ¬í˜„í•˜ì§€ ì•Šì•„ë„ ëœë‹¤. 

```java
public interface MessageConverter{
    Message toMessage(Object object, Session session) throws JMSException, MessageConversionException;
    Object fromMessage(Message message)
}
```

**ê³µí†µì ì¸ ë³€í™˜ ì‘ì—…ì„ í•´ì£¼ëŠ” ìŠ¤í”„ë§ ë©”ì‹œì§€ ë³€í™˜ê¸°**
|ë©”ì‹œì§€ ë³€í™˜ê¸°|í•˜ëŠ” ì¼|
|:--:|:--:|
|MappingJackson2MessageConverter|Jackson 2 JSON ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•´ì„œ ë©”ì‹œì§€ë¥¼ JSONìœ¼ë¡œ ìƒí˜¸ë³€í™˜í•œë‹¤|
|MarshallingMessageConverter|JAXBë¥¼ ì‚¬ìš©í•´ì„œ ë©”ì‹œì§€ë¥¼ XMLë¡œ ìƒí˜¸ë³€í™˜í•œë‹¤|
|MessagingMessageConverter|ìˆ˜ì‹ ëœ ë©”ì‹œì§€ì˜ MessageConverterë¥¼ ì‚¬ìš©í•´ì„œ í•´ë‹¹ ë©”ì‹œì§€ë¥¼ Messageê°ì²´ë¡œ ìƒí˜¸ ë³€í™˜í•œë‹¤. ë˜ëŠ” JMSí—¤ë”ì™€ ì—°ê´€ëœ JmsHeaderMapperë¥¼ í‘œì¤€ ë©”ì‹œì§€ í—¤ë”ë¡œ ìƒí˜¸ë³€í™˜í•œë‹¤|
|SimpleMessageConverter|ë¬¸ìì—´ì„ TextMessageë¡œ byteë°°ì—´ì„ ByteMessageë¡œ Mapì„ MapMessageë¡œ, Serializableê°ì²´ë¥¼ ObjectMessageë¡œ ìƒí˜¸ë³€í™˜í•œë‹¤|

- ê¸°ë³¸ì ìœ¼ë¡œëŠ”Â `SimpleMessageConverter`ê°€ ì‚¬ìš©ëœë‹¤.
    - ì´ ê²½ìš° ì „ì†¡ë  ê°ì²´ê°€ Serializable ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ëŠ” ê²ƒì´ì–´ì•¼ í•œë‹¤.
- Serializableì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•´ì•¼í•œë‹¤ëŠ” ì œì•½ì„ í”¼í•˜ê¸° ìœ„í—¤ `MappingJackson2MessageConverter`ì™€ ê°™ì€ ë‹¤ë¥¸ ë©”ì‹œì§€ ë³€í™˜ê¸°ë¥¼ ì‚¬ìš©í•  ìˆ˜ë„ ìˆë‹¤.
    - ë‹¤ë¥¸ ë©”ì‹œì§€ ë³€í™˜ê¸°ë¥¼ ì ìš©í•  ë•ŒëŠ” í•´ë‹¹ ë³€í™˜ê¸°ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë¹ˆìœ¼ë¡œ ì„ ì–¸ë§Œ í•˜ë©´ëœë‹¤.

`MappingJackson2MessageConverter()`: **ë‹¤ë¥¸ ë©”ì‹œì§€ ë³€í™˜ê¸°ë¥¼ ì ìš©í•  ê²½ìš°**

```java
@Bean
public MappingJackson2MessageConverter messageConverter(){
    MappingJackson2MessageConverter messageConverter = new MappingJackson2MessageConverter();

    messageConverter.setTypeIdPropertyName("_typeId");  // 2) ë°˜í™˜ë˜ëŠ” íƒ€ì…ì˜ í´ë˜ìŠ¤ ì´ë¦„ì´ í¬í•¨ëœë‹¤.
    return messageConverter;  // 1) ë©”ì‹œì§€ ë³€í™˜ê¸° ì¸ìŠ¤í„´ìŠ¤ ë°˜í™˜
}
```

1) MappingJackson2MessageConverterì˜ setTypeIdPropertyName() ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•œ í›„ ì´ ë©”ì‹œì§€ ë³€í™˜ê¸° ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°˜í™˜í•œë‹¤ëŠ” ì ì´ ì¤‘ìš”í•˜ë‹¤.

- ìˆ˜ì‹ ëœ ë©”ì‹œì§€ì˜ ë³€í™˜ íƒ€ì…ì„ ë©”ì‹œì§€ ìˆ˜ì‹ ìê°€ ì•Œì•„ì•¼ í•œë‹¤.

2) `_typeId`: ë°˜í™˜ë˜ëŠ” íƒ€ì…ì˜ í´ë˜ìŠ¤ ì´ë¦„ì´ í¬í•¨ëœë‹¤.

- ë©”ì‹œì§€ ìˆ˜ì‹ ìë„ ë˜‘ê°™ì€ í´ë˜ìŠ¤(íŒ¨í‚¤ì§€ ì „ì²´ ê²½ë¡œ í¬í•¨)ì™€ íƒ€ì…ì„ ê°€ì ¸ì•¼í•˜ê¸° ë•Œë¬¸ì— ìœ ì—°ì„±ì´ ë–¨ì–´ì§„ë‹¤.
- ë”°ë¼ì„œ ìœ ì—°ì„±ì„ ë†’ì´ê¸° ìœ„í•´ ë©”ì‹œì§€ ë³€í™˜ê¸°ì˜ setTypeIdMappings()ë¥¼  í˜¸ì¶œí•˜ì—¬ ì‹¤ì œ íƒ€ì…ì— ì„ì˜ì˜ íƒ€ì… ì´ë¦„ì„ ë§¤í•‘ì‹œí‚¬ ìˆ˜ ìˆë‹¤.

`setTypeIdMappings()`: **ì‹¤ì œ íƒ€ì…ì— ì„ì˜ì˜ íƒ€ì… ì´ë¦„ì„ ë§¤í•‘ì‹œí‚¤ê¸°**

```java
@Bean
public MappingJackson2MessageConverter messageConverter(){
     MappingJackson2MessageConverter messageConverter = new MappingJackson2MessageConverter();

    messageConverter.setTypeIdPropertyName("_typeId");
    
    Map<String,Class<?>> typeIdMappings=new HashMap<String,Class<?>>();
    typeIdMappings.put("order",Order.class);
    messageConverter.setTypeIdMappings(typeIdMappings);

    return messageConverter;
}
```

- í•´ë‹¹ ë©”ì‹œì§€ì˜ _typeIdì†ì„±ì— ì „ì†¡ë˜ëŠ” í´ë˜ìŠ¤ ì´ë¦„ ëŒ€ì‹  orderê°’ì´ ì „ì†¡ëœë‹¤.
- í•´ë‹¹ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì—ëŠ” ì´ì™€ ìœ ì‚¬í•œ ë©”ì‹œì§€ ë³€í™˜ê¸°ê°€ êµ¬ì„±ë˜ì–´ ìˆì„ ê²ƒì´ë¯€ë¡œ orderë¥¼ ìì‹ ì´ ì•Œê³  ìˆëŠ” ì£¼ë¬¸ ë°ì´í„°ë¡œ ë§¤í•‘í•˜ë©´ ëœë‹¤.
- ì¦‰, ì£¼ë¬¸ ë°ì´í„°ê°€ ë‹¤ë¥¸ íŒ¨í‚¤ì§€ì— ë‹¤ë¥¸ í´ë˜ìŠ¤ ì´ë¦„ìœ¼ë¡œ êµ¬í˜„ë  ìˆ˜ ìˆë‹¤.

### #. í›„ì²˜ë¦¬ ë©”ì‹œì§€

ìˆ˜ìµì„±ì´ ì¢‹ì€ ì›¹ ë¹„ì¦ˆë‹ˆìŠ¤ì— ì¶”ê°€í•´ íƒ€ì½” ì±„ì¸ì ì„ ê°œì„¤í–ˆë‹¤ê³  ê°€ì •í•˜ì.

ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ì€ ë‹¤ë¥¸ ì£¼ë¬¸ì ˆì°¨ë¥¼ ì‚¬ìš©í• ê²ƒì´ë‹¤.

ì´ ê²½ìš° ì˜¨ë¼ì¸ ì£¼ë¬¸ì„ ë‚˜íƒ€ë‚´ëŠ” WEBë˜ëŠ” ì˜¤í”„ë¼ì¸ ê°€ê²Œì£¼ë¬¸ì„ ë‚˜íƒ€ë‚´ëŠ” STOREë¥¼ ê°’ìœ¼ë¡œ ê°–ëŠ” ìƒˆë¡œìš´ sourceì†ì„±ì„ orderê°ì²´ì— ì¶”ê°€í•˜ëŠ”ê²ƒì´ì¢‹ì„ê²ƒì´ë‹¤

ê·¸ëŸ¬ë‚˜ ì›¹ ì‚¬ì´íŠ¸ì˜ Orderí´ë˜ìŠ¤ì™€ ì£¼ë°© ì• í”Œë¦¬ì¼€ì´ì…˜ Order í´ë˜ìŠ¤ë¥¼ ëª¨ë‘ ë³€ê²½í•´ì•¼í•˜ê³  ì´ ì •ë³´ëŠ” ì˜¤ì§ íƒ€ì½” ì¤€ë¹„ì—ë§Œ í•„ìš”í•˜ë‹¤.

ì´ë•Œ ì£¼ë¬¸ì´ ë“¤ì–´ì˜¨ ê²½ë¡œì˜ ì •ë³´ë¥¼ ì „ë‹¬í•˜ê¸° ìœ„í•´ ì»¤ìŠ¤í…€ í—¤ë”ë¥¼ ë©”ì‹œì§€ì— ì¶”ê°€í•˜ëŠ”ê²ƒì´ ê°€ì¥ ì‰¬ìš´ ë°©ë²•ì´ë‹¤.

send()ë¥¼ ì‚¬ìš©í•´ ì£¼ë¬¸í•œë‹¤ë©´ setStringProperty()ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

```java
jms.send("tacocloud.order.queue",
    session -> {
        Message message=session.createObjectMessage(order);
        message.setStringProperty("X_ORDER_SOURCE","WEB");  // <= setStringProperty() ì‚¬ìš©
    }
);
```

- ê·¸ëŸ¬ë‚˜ send()ê°€ ì•„ë‹Œ `convertAndSend()`ë¥¼ ì‚¬ìš©í•˜ë©´ Message ê°ì²´ê°€ ë‚´ë¶€ì ìœ¼ë¡œ ìƒì„±ë˜ë¯€ë¡œ ì ‘ê·¼í• ìˆ˜ì—†ë‹¤.
- ë‚´ë¶€ì ìœ¼ë¡œ ìƒì„±ëœ Messageê°ì²´ë¥¼ ì „ì†¡ì „ì— ë³€ê²½í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì´ ìˆëŠ”ë° `convertAndSend()`ì˜ ë§ˆì§€ë§‰ ì¸ìë¡œ `MessagePostProcessor`ë¥¼ ì „ë‹¬í•˜ë©´ Messageê°ì²´ê°€ ìƒì„±ëœ í›„ ì´ ê°ì²´ì— ìš°ë¦¬ê°€ í•„ìš”í•œ ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ìˆë‹¤.

`MessagePostProcessor`: **`convertAndSend()`ë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ X_ORDER_SOURCE í—¤ë”ë¥¼ ì¶”ê°€í•˜ëŠ” ë°©ë²•**

```java
// 1. ì¼ë°˜ì ì¸ êµ¬í˜„
jms.convertAndSend("tacocloud.order.queue", order, new MessagePostProcessor(){  // <= MessagePostProcessor ì‚¬ìš©
    @Override
    public Message postProcessMessage(Message message) throws JMSException{
        message.setStringProperty("X_ORDER_SOURCE","WEB");
        return message;
    }
});

// 2. ëŒë‹¤ì‹ í™œìš©
jms.convertAndSend("tacocloud.order.queue", order,
  message -> {
      message.setStringProperty("X_ORDER_SOURCE","WEB");
      return message;
  });
```

- êµ¬í˜„ëœ `**MessagePostProcessor**`ëŠ” ì´ ì½”ë“œì˜ `**convertAndSend()**`ì—ì„œë§Œ ì‚¬ìš©ë  ìˆ˜ ìˆë‹¤.
- ë‹¤ìŒê³¼ ê°™ì´ ë¦¬íŒ©í† ë§ í•˜ë©´ ë‹¤ë¥¸ convertAndSend() í˜¸ì¶œì—ì„œ ë™ì¼í•œ MessagePostProcessorë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

```java
@GetMapping("/convertAndSend/order")
public String convertAndSendOrder(){
    Order order=buildOrder();
    jms.convertAndSend("tacocloud.order.queue",order,
    this::addOrderSource);  // <= ì‚¬ìš©

    return "Convert and sent order";
}

private Message addOrderSource(Message message) throws JMSException{  // <= MessagePostProcessor ë¦¬íŒ©í† ë§
    message.setStringProperty("X_ORDER_SOURCE","WEB");
    return message;
}
```

# 1.3. JMS ë©”ì‹œì§€ ìˆ˜ì‹ í•˜ê¸°

**ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ëŠ” ë°©ë²•**

1. í’€ ëª¨ë¸: ìš°ë¦¬ ì½”ë“œì—ì„œ ë©”ì‹œì§€ë¥¼ ìš”ì²­í•˜ë©´ ìŠ¤ë ˆë“œì—ì„œ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•  ìˆ˜ ìˆì„ë•Œê¹Œì§€ ëŒ€ê¸°í•œë‹¤.
2. í‘¸ì‹œ ëª¨ë¸: ë©”ì‹œì§€ê°€ ìˆ˜ì‹  ê°€ëŠ¥í•˜ê²Œ ë˜ë©´ ìš°ë¦¬ ì½”ë“œë¡œ ìë™ ì „ë‹¬í•œë‹¤.
    - ì¥ì : ìŠ¤ë ˆë“œì˜ ì‹¤í–‰ì„ ë§‰ì§€ ì•Šìœ¼ë¯€ë¡œ í‘¸ì‹œëª¨ë¸ì´ ì¢‹ë‹¤.
    - ë‹¨ì : ë§ì€ ë©”ì‹œì§€ê°€ ë™ì‹œì— ë„ì°©í•œë‹¤ë©´ ë¦¬ìŠ¤ë„ˆì— ê³¼ë¶€í•˜ê°€ ìƒê¸¸ ìˆ˜ ìˆë‹¤.
- JmsTemplateì€ ëª¨ë“  ë©”ì†Œë“œê°€ í’€ëª¨ë¸ì„ ì‚¬ìš©í•œë‹¤.

### 1.3.1. JmsTemplateì„ ì‚¬ìš©í•´ì„œ ë©”ì‹œì§€ ìˆ˜ì‹ í•˜ê¸°

ë‹¤ìŒì˜ ë©”ì†Œë“œë¥¼ í¬í•¨í•´ì„œ JmsTemplateì€ ë¸Œë¡œì»¤ë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì—¬ëŸ¬ê°œì˜ ë©”ì†Œë“œë¥¼ ì œê³µí•œë‹¤.

```java
// send() ëŒ€ì‘
// 1) ì›ì‹œ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ 
Message receive() throws JmsException;
Message receive(Destination destination) throws JmsException;  // 3) Destination 
Message receive(String destinationName) throws JmsException;

// convertAndSend() ëŒ€ì‘
// 2) ë©”ì‹œì§€ë¥¼ ë„ë©”ì¸ íƒ€ì…ìœ¼ë¡œ ë³€í™˜í•˜ê¸° ìœ„í•´ êµ¬ì„±ëœ ë©”ì‹œì§€ ë³€í™˜ê¸°ë¥¼ ì‚¬ìš©
Object receiveAndConvert() throws JmsException;
Object receiveAndConvert(Destination destination) throws JmsException;  // 3) Destination 
Object receiveAndConvert(String destinationName) throws JmsException;
```

1) receive()ë©”ì†Œë“œëŠ” ì›ì‹œ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•œë‹¤. 

2) receiveAndConvert()ë©”ì†Œë“œëŠ” ë©”ì‹œì§€ë¥¼ ë„ë©”ì¸ íƒ€ì…ìœ¼ë¡œ ë³€í™˜í•˜ê¸° ìœ„í•´ êµ¬ì„±ëœ ë©”ì‹œì§€ ë³€í™˜ê¸°ë¥¼ ì‚¬ìš©í•œë‹¤.

3) ê° ë©”ì†Œë“œì—ì„œ ë„ì°©ì§€ ì´ë¦„ì„ ê°–ëŠ” `Destination` ê°ì²´ë‚˜ ë¬¸ìì—´ì„ ì§€ì •í•˜ê±°ë‚˜ ê¸°ë³¸ ë„ì°©ì§€ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

### #. **íì—ì„œ ì£¼ë¬¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°**

**`receive()`: ë³€í™˜ë˜ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ì‹ í•˜ê¸°**

```java
@Component
public class JmsOrderReceiver implements OrderReceiver{
    private JmsTemplate jms;
    private MessageConverter converter;

    @Autowired
    public JmsOrderService(JmsTemplate jms, MessageConverter converter){
        this.jms=jms;
        this.converter=converter;
    }

    public Order receiveOrder(){
        Message message=jns.receive("tacocloud.order.queue)";  // 1) 
        return (Order) converter.froMessage(message);  // 3) 
    }
}
```

1) ì£¼ë¬¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ë„ì°©ì§€ë¥¼ Stringìœ¼ë¡œ ì§€ì •í–ˆë‹¤.

2) receive() ë©”ì„œë“œëŠ” ë³€í™˜ë˜ì§€ ì•Šì€ ë©”ì‹œì§€ë¥¼ ë°˜í™˜í•œë‹¤.

3) ê·¸ëŸ¬ë‚˜ ì—¬ê¸°ì„œ í•„ìš”í•œê²ƒì€ ë©”ì‹œì§€ ë‚´ë¶€ì˜ Orderê°ì²´ì´ê¸° ë–„ë¬¸ì— ì£¼ì…ëœ ë©”ì‹œì§€ ë³€í™˜ê¸°ë¥¼ ì‚¬ìš©í•´ receive() ë©”ì†Œë“œê°€ ë°˜í™˜í•œ ìˆ˜ì‹  ë©”ì‹œì§€ë¥¼ Orderê°ì²´ë¡œ ë³€í™˜í•œë‹¤.

- ìˆ˜ì‹  ë©”ì‹œì§€ì˜ íƒ€ì… Idì†ì„±ì€ í•´ë‹¹ ë©”ì‹œì§€ë¥¼ Orderê°ì²´ë¡œ ë³€í™˜í•˜ë¼ê³  ì•Œë ¤ì¤€ë‹¤. í•˜ì§€ë§Œ ë³€í™˜ëœ ê°ì²´ì˜ íƒ€ì…ì€ Objectì´ë¯€ë¡œ ìºìŠ¤íŒ…í›„ ë°˜í™˜í•´ì•¼í•œë‹¤.

ë©”ì‹œì§€ì˜ ì†ì„±ê³¼ í—¤ë”ë¥¼ ì‚´í´ë´ì•¼ í•  ë•ŒëŠ” ì›ì‹œÂ `Message`ê°ì²´ë¥¼ ë©”ì‹œì§€ë¡œ ìˆ˜ì‹ í•˜ëŠ” ê²ƒì´ ìœ ìš©í• ìˆ˜ ìˆë‹¤.

ê·¸ëŸ¬ë‚˜ ë©”ì‹œì§€ì˜ ë©”íƒ€ë°ì´í„°ëŠ” í•„ìš”ì—†ê³  **í˜ì´ë¡œë“œ**ë§Œ í•„ìš”í•  ë•Œê°€ ìˆë‹¤.

ì´ ê²½ìš° ë‘ë‹¨ê³„ì˜ ì ˆì°¨ë¡œ í˜ì´ë¡œë“œë¥¼ ë„ë©”ì¸ íƒ€ì…ìœ¼ë¡œ ë³€í™˜í•˜ë©°, ë©”ì‹œì§€ ë³€í™˜ê¸°ê°€ í•´ë‹¹ ì»´í¬ë„ŒíŠ¸ì— ì£¼ì…ë˜ì–´ì•¼í•œë‹¤.

ë©”ì‹œì§€ì˜ í˜ì´ë¡œë“œë§Œ í•„ìš”í• ë•ŒëŠ” `receiveAndConvert()`ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë” ê°„ë‹¨í•˜ë‹¤.

*í˜ì´ë¡œë“œ: ë©”ì‹œì§€ì— ì ì¬ëœ ìˆœìˆ˜í•œ ë°ì´í„°. ex) Order ê°ì²´

`**receiveAndConvert()`: ë³€í™˜ëœ Order ê°ì²´ ìˆ˜ì‹ í•˜ê¸°**

```java
@Component
public class JmsOrderReceiver implements OrderReceiver{
    private JmsTemplate jms;

    @Autowired
    public JmsOrderReceiver(JmsTemplate jms){
        this.jms=jms;
    }
    public Order receiveOrder(){  // 2) 
        return (Order) jms.receiveAndConvert("tacocloud.order.queue");  // 1) ë©”ì‹œì§€ ë‚´ë¶€ ë³€í™˜ ìˆ˜í–‰
    }
}
```

1) ëª¨ë“  ë©”ì‹œì§€ ë³€í™˜ì€ ë‚´ë¶€ì ìœ¼ë¡œ receiveAndConvert()ì—ì„œ ìˆ˜í–‰ëœë‹¤.

- MessageConverterë¥¼ ì£¼ì…í•  í•„ìš”ê°€ ì—†ë‹¤.

2) íƒ€ì½” í´ë¼ìš°ë“œ ì£¼ë°© ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ receiveOrder() ì‚¬ìš© ë°©ë²•

1. íƒ€ì½” í´ë¼ìš°ë“œ ì£¼ë°©ë“¤ì¤‘ í•˜ë‚˜ì—ì„œ ì¼í•˜ëŠ” ìŒì‹ ì¡°ë¦¬ì‚¬ëŠ” íƒ€ì½”ë¥¼ ë§Œë“¤ ì¤€ë¹„ê°€ ë˜ì—ˆë‹¤ëŠ” ê²ƒì„ ë‚˜íƒ€ë‚´ê¸° ìœ„í•´ ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜ ë‹¤ë¥¸ì•¡ì…˜ì„ ì·¨í•  ìˆ˜ ìˆë‹¤.
2. receiveOrder()ê°€ í˜¸ì¶œë˜ì–´ receive()ë‚˜ receiveAndConvert()ê°€ ìˆ˜í–‰ë  ê²ƒì´ë©°, ì£¼ë¬¸ ë©”ì‹œì§€ê°€ ìˆ˜ì‹ ë  ë•Œê¹Œì§€ëŠ” ì•„ë¬´ì¼ë„ ìƒê¸°ì§€ì•ŠëŠ”ë‹¤.
3. ì£¼ë¬¸ ë©”ì‹œì§€ê°€ ìˆ˜ì‹ ë˜ë©´ receiveOrder()ë¡œë¶€í„° ë°˜í™˜ë˜ê³  ì´ ì •ë³´ëŠ” ì¡°ë¦¬ì‚¬ê°€ ì¼ì„ í•˜ë„ë¡ ì£¼ë¬¸ ëª…ì„¸ë¥¼ ë³´ì—¬ì£¼ëŠ”ë° ì‚¬ìš©ëœë‹¤.
- ì§€ê¸ˆê¹Œì§€ í’€ëª¨ë¸ êµ¬í˜„í–ˆë‹¤.

## 1.3.2. ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ ì„ ì–¸í•˜ê¸°

`receive()`ë‚˜Â `receiveAndConvert()`ë¥¼ í˜¸ì¶œí•´ì•¼ í•˜ëŠ” í’€ ëª¨ë¸ê³¼ ë‹¬ë¦¬, ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆëŠ” ë©”ì‹œì§€ê°€ ë„ì°©í•  ë•Œê¹Œì§€ ëŒ€ê¸°í•˜ëŠ” ìˆ˜ë™ì  ì»´í¬ë„ŒíŠ¸ë‹¤.

JMS ë©”ì‹œì§€ì— ë°˜ì‘í•˜ëŠ” ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆë¥¼ ìƒì„±í•˜ë ¤ë©´ ì»´í¬ë„ŒíŠ¸ì˜ ë©”ì†Œë“œì—Â `@JmsListener`ë¥¼ ì§€ì •í•´ì•¼í•œë‹¤.

**ì£¼ë¬¸ ë°ì´í„°ë¥¼ ë¦¬ìŠ¤ë‹í•˜ëŠ” OrderListenerì»´í¬ë„ŒíŠ¸**

```java
@Component
public class OrderListener{
    private KitchenUI ui;

    @Autowired
    public OrderListener(KitchenUI ui){
        this.ui=ui;
    }
		// 1) tacocloud.order.queueë„ì°©ì§€ì˜ ë©”ì‹œì§€ë¥¼Â ë¦¬ìŠ¤ë‹í•˜ê¸° ìœ„í•´Â @JmsListenerì• ë…¸í…Œì´ì…˜ì´ ì§€ì •
    @JmsListener(destination = "tacocloud.order.queue")  
    public void receiveOrder(Order order){  // 1)
        ui.displayOrder(order);
    }
}
```

1) `receiveOrder()`ë©”ì†Œë“œì—ëŠ” tacocloud.order.queueë„ì°©ì§€ì˜ ë©”ì‹œì§€ë¥¼Â `ë¦¬ìŠ¤ë‹`í•˜ê¸° ìœ„í•´Â `@JmsListener`ì• ë…¸í…Œì´ì…˜ì´ ì§€ì •ë˜ì—ˆë‹¤.

- ì´ ë©”ì†Œë“œëŠ” JmsTemplateì„ ì‚¬ìš©íˆì§€ ì•Šìœ¼ë©°, ìš°ë¦¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œì—ì„œë„ í˜¸ì¶œë˜ì§€ ì•ŠëŠ”ë‹¤.
- ëŒ€ì‹ ì— ìŠ¤í”„ë§ì˜ í”„ë ˆì„ì›Œí¬ ì½”ë“œê°€ íŠ¹ì • ë„ì°©ì§€ì— ë©”ì‹œì§€ê°€ ë„ì°©í•˜ëŠ” ê²ƒì„ ê¸°ë‹¤ë¦¬ë‹¤ê°€ ë„ì°©í•˜ë©´ í•´ë‹¹ ë©”ì‹œì§€ì— ì ì¬ëœ Orderê°ì²´ê°€ ì¸ìë¡œ ì „ë‹¬ë˜ë©´ì„œ receiveOrder()ë©”ì†Œë“œê°€ ìë™ìœ¼ë¡œ í˜¸ì¶œëœë‹¤.

- ì—¬ëŸ¬ë©´ì—ì„œÂ `@JmsListener`ì• ë…¸í…Œì´ì…˜ì€ ìŠ¤í”„ë§ MVCì˜ ìš”ì²­ë§¤í•‘ ì• ë…¸í…Œì´ì…˜ê³¼ ìœ ì‚¬í•œë°Â `@JmsListener`ê°€ ì§€ì •ëœ ë©”ì†Œë“œë“¤ì€ ì§€ì •ëœ ë„ì°©ì§€ì— ë“¤ì–´ì˜¤ëŠ” ë©”ì‹œì§€ì— ë°˜ì‘í•œë‹¤
- ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆëŠ” ì¤‘ë‹¨ì—†ì´ ë‹¤ìˆ˜ì˜ ë©”ì‹œì§€ë¥¼ ë¹ ë¥´ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆì–´ì„œ ì¢‹ì€ì„ íƒì´ ë  ë•Œê°€ ìˆë‹¤.
- ê·¸ëŸ¬ë‚˜ íƒ€ì½” í´ë¼ìš°ë“œì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê²½ìš° ì£¼ë°©ì˜ ìŒì‹ì¡°ë¦¬ì‚¬ê°€ ì£¼ë¬¸ì´ ë“¤ì–´ì˜¤ëŠ” ë§Œí¼ ë¹ ë¥´ê²Œ íƒ€ì½”ë¥¼ ì¤€ë¹„í•  ìˆ˜ ì—†ì–´ì„œ ë³‘ëª©í˜„ìƒì´ ìƒê¸¸ìˆ˜ ìˆë‹¤.
- ê·¸ë˜ì„œ ì§ì›ì—ê²Œ ê³¼ë¶€í•˜ê°€ ê±¸ë¦¬ì§€ ì•Šë„ë¡ ì£¼ë°©ì˜ ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ëŠ” ë„ì°©í•˜ëŠ” ì£¼ë¬¸ì„ ë²„í¼ë§í•´ì•¼í•œë‹¤.
- ë©”ì‹œì§€ë¦¬ìŠ¤ë„ˆëŠ” ë‚˜ì˜ë‹¤ëŠ”ê²Œ ì•„ë‹ˆë¼ ë©”ì‹œì§€ê°€ ë¹ ë¥´ê²Œ ì²˜ë¦¬ë  ìˆ˜ ìˆì„ë•ŒëŠ” ë”± ë§ëŠ”ë‹¤.

`JmsTemplate`

**ì¥ì **

- ë©”ì‹œì§€ ì²˜ë¦¬ê¸°ê°€ ìì‹ ì˜ ì‹œê°„ì— ë§ì¶° ë”ë§ì€ ë©”ì‹œì§€ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆì–´ì•¼ í•  ë•Œ ì¢‹ë‹¤.
- ìë°” í‘œì¤€ ëª…ì„¸ì— ì •ì˜

**ë‹¨ì **

- ìë°” ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ

`RabbitMQ`ì™€ `Kafka` ê°™ì€ ìƒˆë¡œìš´ ë©”ì‹œì§• ì‹œìŠ¤í…œì€ ì´ëŸ° ë‹¨ì ì„ í•´ê²°í•´ ë‹¤ë¥¸ ì–¸ì–´ì™€ JVMì™¸ì˜ ë‹¤ë¥¸ í”Œë«í¼ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

# ğŸ“˜ 2. RabbitMQì™€ AMQP ì‚¬ìš©í•˜ê¸°

---

- AMQPì˜ ê°€ì¥ ì¤‘ìš”í•œ êµ¬í˜„ì´ë¼ í•  ìˆ˜ ìˆëŠ”Â `RqbbitMQ`ëŠ” JMSë³´ë‹¤ ë” ì§„ë³´ëœ ë©”ì‹œì§€ ë¼ìš°íŒ… ì „ëµì„ ì œê³µí•œë‹¤.
- JMSë©”ì‹œì§€ê°€ ìˆ˜ì‹ ìê°€ ê°€ì ¸ê°ˆ ë©”ì‹œì§€ ë„ì°©ì§€ì˜ ì´ë¦„ì„ ì£¼ì†Œë¡œ ì‚¬ìš©í•˜ëŠ” ë°˜ë©´, AMQPë©”ì‹œì§€ëŠ” ìˆ˜ì‹ ìê°€ ë¦¬ìŠ¤ë‹í•˜ëŠ” íì™€ ë¶„ë¦¬ëœ Exchange ì´ë¦„ê³¼ ë¼ìš°íŒ… í‚¤ë¥¼ ì£¼ì†Œë¡œ í•œë‹¤.
- **ë©”ì‹œì§€ ìˆ˜ì‹ í†µë³´**
    - ë§ì€Â í”„ë¡œí† ì½œì´Â ë©”ì„¸ì§€Â ì „ë‹¬Â ë³´ì¥ì„Â ìœ„í•´Â ACKnowledgementÂ ê°œë…ì„Â ì‚¬ìš©í•˜ë©°,Â Â ë©”ì‹œì§€Â ì‘ë‹µÂ ì„Â ë³´ë‚´ì£¼ë„ë¡Â ë˜ì–´ìˆë‹¤.
    - ACKë¥¼Â ì „ì†¡í•˜ì§€Â ì•Šê³ Â ConsumerÂ ê°€Â ì˜¤ë¥˜ê°€ë‚˜ê±°ë‚˜Â TCPÂ ì—°ê²°ì´Â ëŠì–´ã…ˆÂ RabbitMQëŠ”Â ë©”ì„¸ì§€ê°€Â ì™„ì „íˆÂ ì²˜ë¦¬ë˜ì§€Â ì•Šì•˜ìŒì„Â ì¸ì‹í•˜ê³ Â Â ë‹¤ì‹œÂ ëŒ€ê¸°Â ì‹œí‚¨ë‹¤.Â ë©”ì„¸ì§€Â ì‹œê°„Â ì´ˆê³¼ê°€Â ì—†ë‹¤.
- **ë©”ì‹œì§€ ë‚´êµ¬ì„±**
    - RabbitMQÂ ì„œë²„ê°€Â ì¤‘ì§€ë˜ë©´Â ì‘ì—…Â ì†ì‹¤ì´Â ìƒê¸¸ìˆ˜Â ìˆë‹¤.
    - ì†ì‹¤ë˜ì§€Â ì•Šë„ë¡Â RabbitMQëŠ”Â ê¸°ëŠ¥ì„Â ì œê³µí•˜ê³ Â ìˆë‹¤.

# âœ³ #. RabbitMQ

### #.0. **AMQP**

- AMQPë€ Advanced Message Queueing Protocolì˜ ì¤„ì„ë§ë¡œ MQì˜ ì˜¤í”ˆì†ŒìŠ¤ì— ê¸°ë°˜í•œ í‘œì¤€ í”„ë¡œí† ì½œì„ ì˜ë¯¸í•œë‹¤.
- AMQPëŠ” ë§ˆì§€ë§‰ `Protocol`ì—ì„œ ë³´ëŠ” ê²ƒê³¼ ê°™ì´ í”„ë¡œí† ì½œì„ ì˜ë¯¸í•˜ê¸° ë•Œë¬¸ì— ì´ ê²ƒì„ ì‚¬ìš©í•œ ê°€ì¥ ìœ ëª…í•œ ì†Œí”„íŠ¸ì›¨ì–´ëŠ” RabbitMQë¼ ë³¼ ìˆ˜ ìˆë‹¤.
- AMQPë¥¼ êµ¬ì„±í•˜ëŠ” ìš”ì†ŒëŠ” Exchange, Queue, Bindingì´ ìˆë‹¤.

## #.1. ë©”ì‹œì§€ ì²˜ë¦¬ í”„ë¡œì„¸ìŠ¤

### #.1.1. Exchange

ProducerÂ ê°€Â ì–´ë– í•œÂ ë©”ì‹œì§€ë„Â Queueì—Â ì§ì ‘Â ë³´ë‚¼ìˆ˜Â ì—†ë„ë¡Â ì„¤ê³„Â ë˜ì–´Â ìˆë‹¤. í”„ë¡œë“€ì…”ëŠ”Â ì˜¤ì§Â Exchangeì—ë§ŒÂ ë©”ì„¸ì§€ë¥¼Â ë³´ë‚¼ìˆ˜Â ìˆëŠ”Â ê²ƒì´ë‹¤.

ExchangeëŠ” ìƒì‚°ìë¡œë¶€í„° ìˆ˜ì‹ í•œ ë©”ì‹œì§€ë¥¼ ì ì ˆí•œ Queueë‚˜ ë‹¤ë¥¸ Exchangeë¡œ ë¶„ë°°í•˜ëŠ” ë¼ìš°í„°ì˜ ê¸°ëŠ¥ì„ í•œë‹¤.

ExchangeëŠ” ìˆ˜ì‹ í•œ ë©”ì‹œì§€ë¥¼ ë¶„ë°°í•˜ê¸° ìœ„í•´ Exchange Typeì´ë¼ëŠ” ë¼ìš°íŒ… ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•œë‹¤.

ë¸Œë¡œì»¤ëŠ” ì—¬ëŸ¬ê°œì˜ Exchange Type ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°€ì§ˆìˆ˜ ìˆë‹¤.

Exchange Typeì„ í•˜ë‹¨ì˜ Bindingê³¼ í˜¼ë™í•  ìˆ˜ ìˆëŠ”ë°, ë‹¤ìŒê³¼ ê°™ì´ ì°¨ì´ë¥¼ êµ¬ë¶„í•  ìˆ˜ ìˆë‹¤.

Exchange Type: ë°›ì€ ë©”ì‹œì§€ë¥¼ ì–´ë–¤ ë°©ë²•ìœ¼ë¡œ ë¼ìš°íŒ…í•  ì§€ ê²°ì •í•˜ëŠ” ê²ƒì´ë‹¤.

Binding: ì´ëŸ¬í•œ ë°©ë²•ìœ¼ë¡œ ê²°ì •ëœ ë©”ì‹œì§€ë¥¼ ì–´ëŠ Queueì— ì „ë‹¬í•  ì§€ ê²°ì •í•˜ëŠ” ë¼ìš°íŒ… í…Œì´ë¸”ì´ë‹¤.

### #.1.2. Queue

- ë©”ëª¨ë¦¬ë‚˜ ë””ìŠ¤í¬ì— ë©”ì‹œì§€ë¥¼ ì €ì¥í•˜ê³ , ê·¸ê²ƒì„ Consumerì—ê²Œ ì „ë‹¬í•˜ëŠ” ì—­í• ì„ í•œë‹¤.
- serverì˜ ë©”ëª¨ë¦¬ ë° ë””ìŠ¤í¬ ì œí•œì— êµ¬ì†ëœë‹¤.

### #.1.3. Binding

- Exchangeì™€ Queueì™€ì˜ ê´€ê³„ë¥¼ ì •ì˜í•œ ì¼ì¢…ì˜ ë¼ìš°íŒ… í…Œì´ë¸”ì´ë‹¤.
- ë™ì¼í•œ Queueê°€ ì—¬ëŸ¬ ê°œì˜ Exchangeì— Binding ë  ìˆ˜ë„ ìˆê³  ë‹¨ì¼ Exchangeì— ì—¬ëŸ¬ ê°œì˜ íê°€ Bindingë  ìˆ˜ë„ ìˆë‹¤.

### #.1.4. Consumer

- ConsumerëŠ” ìì‹ ì´ ë°”ë¼ë³´ê³  ìˆëŠ” Queueë¥¼ ë¦¬ìŠ¤ë‹ í•˜ë‹¤ê°€ Queueê°€ ì‚½ì… ë˜ì—ˆì„ ë•Œ Messageë¥¼ ìˆ˜ì‹ í•˜ì—¬ ì²˜ë¦¬í•œë‹¤.

## #.2. Standard Exchange Type (Exchangeì˜ ì¢…ë¥˜)

Exchange Typeì€ ë©”ì‹œì§€ë¥¼ ì–´ë–¤ ë°©ë²•ìœ¼ë¡œ ë¼ìš°íŒ…í• ì§€ ê²°ì •í•˜ëŠ” ì•Œê³ ë¦¬ì¦˜ì´ë‹¤.

AMQPì—ì„œëŠ” Standard Exchange Typeìœ¼ë¡œ ë¼ìš°íŒ… í‚¤ì— ê¸°ë°˜í•œ ë¼ìš°íŒ… ì•Œê³ ë¦¬ì¦˜ê³¼ key-value í—¤ë”ì— ê¸°ë°˜í•œ 1ê°œ ìœ í˜•ì˜ Exchange Typeì„ ì •ì˜í•´ì•¼ í•œë‹¤.

- Exchange ì˜ ê°€ì¥ ê°„ë‹¨í•œ í˜•íƒœëŠ” ê¸°ë³¸ Exchange ì™€ íŒ¬ì•„ì›ƒ Exchange ì´ë©° ì´ê²ƒë“¤ì€ JMSì˜ í ë° í† í”½ê³¼ ê±°ì˜ ì¼ì¹˜í•œë‹¤.
- ê·¸ëŸ¬ë‚˜ ë‹¤ë¥¸ exchangeë“¤ì„ ì‚¬ìš©í•˜ë©´ ë” ìœ ì—°í•œ ë¼ìš°íŒ… ìŠ¤í‚´ì„ ì •ì˜í•  ìˆ˜ ìˆë‹¤. ë©”ì‹œì§€ëŠ” ë¼ìš°íŒ… í‚¤ë¥¼ ê°–ê³  Exchange ë¡œ ì „ë‹¬ë˜ê³ 
- íì—ì„œ ì½í˜€ì ¸ ì†Œë¹„ëœë‹¤ëŠ” ê²ƒì„ ì´í•´í•˜ëŠ”ê²ƒì´ ê°€ì¥ ì¤‘ìš”í•˜ë‹¤. ë©”ì‹œì§€ëŠ” ë°”ì¸ë”© ì •ì˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ Exchange ë¡œë¶€í„° íë¡œ ì „ë‹¬ëœë‹¤.

### **#.2.1. Exchangeì˜ ì¢…ë¥˜**

**ê¸°ë³¸**(default): ë¸Œë¡œì»¤ê°€ ìë™ìœ¼ë¡œ ìƒì„±í•˜ëŠ” íŠ¹ë³„í•œ Exchange . í•´ë‹¹ ë©”ì‹œì§€ì˜ ë¼ìš°íŒ… í‚¤ì™€ ì´ë¦„ì´ ê°™ì€ íë¡œ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•œë‹¤. ëª¨ë“  íëŠ” ìë™ìœ¼ë¡œ ê¸°ë³¸ Exchange ì™€ ì—°ê²°ëœë‹¤.

**ë‹¤ì´ë ‰íŠ¸**(direct): ë°”ì¸ë”© í‚¤ê°€ í•´ë‹¹ ë©”ì‹œì§€ì˜ Routing Keyì™€ ê°™ì€ Queueì— ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•œë‹¤. ë©”ì‹œì§€ì˜ ë¼ìš°íŒ… í‚¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ 1:Nìœ¼ë¡œ Queueì— ë§¤ì¹­ì‹œí‚¤ëŠ” ë°©ë²•ì´ë‹¤.

**í† í”½**(Topic): ë°”ì¸ë”© í‚¤ê°€ í•´ë‹¹ ë©”ì‹œì§€ì˜ ë¼ìš°íŒ… í‚¤ì™€ ì¼ì¹˜í•˜ëŠ” í•˜ë‚˜ ì´ìƒì˜ íì— ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•œë‹¤. ì™€ì¼ë“œì¹´ë“œë¥¼ ì´ìš©í•´ì„œ ë©”ì‹œì§€ë¥¼ Queueì— ë§¤ì¹­ì‹œí‚¤ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

- [com.event.#(ì—¬ëŸ¬ë‹¨ì–´)](https://mycup.tistory.com/manage/newpost/com.event.#(%EC%97%AC%EB%9F%AC%EB%8B%A8%EC%96%B4))
- [com.event.*(í•œë‹¨ì–´)](https://mycup.tistory.com/manage/newpost/com.event.*(%ED%95%9C%EB%8B%A8%EC%96%B4))

**íŒ¬ì•„ì›ƒ**(Fanout): ë°”ì¸ë”© í‚¤ë‚˜ ë¼ìš°íŒ… í‚¤ì— ìƒê´€ì—†ì´ ëª¨ë“  ì—°ê²°ëœ íì— ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•œë‹¤. ëª¨ë“  ë©”ì‹œì§€ë¥¼ Queueì— ë§¤ì¹­í•˜ëŠ” ë°©ë²•ì´ë‹¤.

**í—¤ë”**(Header): í† í”½ Exchange ì™€ ìœ ì‚¬í•˜ë©°, ë¼ìš°íŒ… í‚¤ ëŒ€ì‹  ë©”ì‹œì§€ í—¤ë”ê°’ì„ ê¸°ë°˜ìœ¼ë¡œ í•œë‹¤ëŠ”ê²ƒë§Œ ë‹¤ë¥´ë‹¤.

- key-valueë¡œ ì •ì˜ëœ í—¤ë”ì— ì˜í•´ ë©”ì‹œì§€ë¥¼ Queueì— ë§¤ì¹­ì‹œí‚¤ëŠ” ë°©ë²•ì´ë‹¤. x-matchë¼ëŠ” argumentë¡œ í—¤ë”ë¥¼ ì–´ë–¤ì‹ìœ¼ë¡œ í•´ì„í•˜ê³  ë§¤ì¹­ì‹œí‚¬ì§€ ê²°ì •í•˜ëŠ”ë°, x-matchê°€ allì´ë©´ ëª¨ë“  ì¡°ê±´ì„ ì¶©ì¡±ì‹œì¼œì•¼ í•œë‹¤ëŠ” ê²ƒì´ê³ (AND), anyì´ë©´ ìµœì†Œ 1ê°œì˜ ì¡°ê±´ë§Œ ì¶©ì¡±ì‹œí‚¤ë©´ ëœë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤.(OR)

**ë°ë“œë ˆí„°**(Dead letter):ì „ë‹¬ ë¶ˆê°€ëŠ¥í•œ ì¦‰, ì •ì˜ëœ ì–´ë–¤ Exchange -í ë°”ì¸ë”©ê³¼ë„ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ëª¨ë“ ë©”ì‹œì§€ë¥¼ ë³´ê´€í•˜ëŠ” ì¡ë™ì‚¬ë‹ˆ Exchange ì´ë‹¤.

![Ch08/Untitled.png](Ch08/Untitled.png)

## #.3.  ì¶”ê°€ìš©ì–´

**Subscribe**

- Consumerê°€ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ê¸° ìœ„í•´ Queueë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¦¬ìŠ¤ë‹í•˜ê³  ìˆëŠ” ì—­í• 

**header**

- í—¤ë”ì— í¬í•¨ëœ Key/Valueì˜ ì¼ì¹˜ ì¡°ê±´ì— ë”°ë¼ ë©”ì‹œì§€ ì „ë‹¬

**Routing Key**

- Exchangeë¡œ Queue Binding ë  ë•Œ ë¼ìš°íŒ… í‚¤ê°€ ì¼ì¹˜ í•˜ëŠ”ì§€ íŒë‹¨í•˜ì—¬ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í• ì§€ íŒë‹¨í•˜ëŠ” ì—­í• ì„ í•¨.

[]()

![Ch08/Untitled%201.png](Ch08/Untitled%201.png)

![Ch08/Untitled%202.png](Ch08/Untitled%202.png)

- RabbitMQ exchangeë¡œ ì „ì†¡ë˜ëŠ” ë©”ì‹œì§€ëŠ” ë¼ìš°íŒ… í‚¤ì™€ ë°”ì¸ë”©ì„ ê¸°ë°˜ìœ¼ë¡œ í•˜ë‚˜ ì´ìƒì˜ íë¡œ ì „ë‹¬ëœë‹¤.
- ë©”ì‹œì§€ê°€ RabbitMQ ë¸Œë¡œì»¤ì— ë„ì°©í•˜ë©´ ì£¼ì†Œë¡œ ì§€ì •ëœ exchangeì— ë“¤ì–´ê°„ë‹¤. í•˜ë‚˜ ì´ìƒì˜ íì— ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•  ì±…ì„ì´ ìˆë‹¤.
- ì´ë•Œ exchange íƒ€ì…, exchangeì™€ í ê°„ì˜ ë°”ì¸ë”©, ë©”ì‹œì§€ì˜ ë¼ìš°íŒ… í‚¤ê°’ì„ ê¸°ë°˜ìœ¼ë¡œ ì²˜ë¦¬í•œë‹¤.

# 2.1. RabbitMQë¥¼ ìŠ¤í”„ë§ì— ì¶”ê°€í•˜ê¸°

ìŠ¤í”„ë§ì„ ì‚¬ìš©í•´ RabbitMQ ë©”ì‹œì§€ë¥¼ ì „ì†¡ ë° ìˆ˜ì‹ í•˜ë ¤ë©´ Artemisë‚˜ ActiveMQëŒ€ì‹ ì— ìŠ¤í”„ë§ ë¶€íŠ¸ì˜ AMQPìŠ¤íƒ€í„° ì˜ì¡´ì„±ì„ ë¹Œë“œì— ì¶”ê°€í•œë‹¤

```java
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```

- AMQP ìŠ¤íƒ€í„°ë¥¼ ë¹Œë“œì— ì¶”ê°€í•˜ë©´ ë‹¤ë¥¸ ì§€ì› ì»´í¬ë„ŒíŠ¸ëŠ” ë¬¼ë¡ ì´ê³  AMQP ì—°ê²° íŒ©í† ë¦¬ì™€ RabbitTemplate ë¹ˆì„ ìƒì„±í•˜ëŠ” ìë™-êµ¬ì„±ì´ ìˆ˜í–‰ëœë‹¤.

### #. RabbitMQ ë¸Œë¡œì»¤ì˜ ìœ„ì¹˜ì™€ ì¸ì¦ ì •ë³´ë¥¼ êµ¬ì„±í•˜ëŠ” ì†ì„±

|ì†ì„±|ì„¤ëª…|
|:--|:--:|
|spring.rabbitmq.addresses|ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ë¦¬ìŠ¤íŠ¸ í˜•íƒœì˜ RabbitMQ ë¸Œë¡œì»¤ ì£¼ì†Œ|
|spring.rabbitmq.host|ë¸Œë¡œì»¤ì˜ í˜¸ìŠ¤íŠ¸(ê¸°ë³¸ê°’ì€ localhost)|
|spring.rabbitmq.port|ë¸Œë¡œì»¤ì˜ í¬íŠ¸(ê¸°ë³¸ê°’ì€ 5672)|
|spring.rabbitmq.username|ë¸Œë¡œì»¤ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì‚¬ìš©ì ì´ë¦„(ì„ íƒì†ì„±)|
|spring.rabbitmq.password|ë¸Œë¡œì»¤ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì‚¬ìš©ì ì•”í˜¸(ì„ íƒì†ì„±)|

- ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤ë¬´í™˜ê²½ìœ¼ë¡œ ì‚¬ìš©í•  ë•Œì— ì‚¬ìš©ëœë‹¤.
- ê°œë°œ ëª©ì ì´ë¼ë©´ RabbitMQ ë¸Œë¡œì»¤ê°€ ë¡œì»¬ì»´í“¨í„°ì—ì„œ ì‹¤í–‰ë˜ê³  5672í¬íŠ¸ë¥¼ ë¦¬ìŠ¤ë‹í•  ê²ƒì´ë©°, ì¸ì¦ì •ë³´ê°€ í•„ìš” ì—†ë‹¤.
    - ë”°ë¼ì„œ ì´ ì†ì„±ë“¤ì€ ê°œë°œ ì‹œì—ëŠ” ë§ì´ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.

ì˜ˆë¥¼ë“¤ì–´ ì‹¤ë¬´í™˜ê²½ìœ¼ë¡œ ì´ì–‘í• ë•Œ RabbitMQë¸Œë¡œì»¤ê°€ rabbit.tacocloud.comì´ë¼ëŠ” ì„œë²„ì—ì„œ ì‹¤í–‰ë˜ê³  5673 í¬íŠ¸ë¥¼ ë¦¬ìŠ¤ë‹í•˜ë©° ì¸ì¦ì •ë³´ê°€ í•„ìš”í•˜ë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì • í•  ìˆ˜ ìˆë‹¤.

```java
spring:
  profiles: prod
  rabbitmq:
    host: rabbit.tacocloud.com
    port: 5673
    useername: tacoweb
    password: l3tm31n
```

# 2.2. RabbitTemplateì„ ì‚¬ìš©í•´ì„œ ë©”ì‹œì§€ ì „ì†¡í•˜ê¸°

`RabbitMQ`ë©”ì‹œì§•ì„ ìœ„í•œ ìŠ¤í”„ë§ ì§€ì›ì˜ í•µì‹¬ì€Â `RabbitTemplate`ì´ë‹¤.

RabbitTemplateì€ JmsTemplateê³¼ ìœ ì‚¬í•œ ë©”ì†Œë“œë“¤ì„ ì œê³µí•˜ì§€ë§Œ RabbitMQ íŠ¹ìœ ì˜ ì‘ë™ ë°©ë²•ì— ë”°ë¥¸ ë¯¸ì„¸í•œ ì°¨ì´ê°€ìˆë‹¤.

ê³µí†µì : `RabbitTemplate`ì„ ì‚¬ìš©í•œ ë©”ì‹œì§€ ì „ì†¡ì˜ ê²½ìš°ì— send()ì™€ convertAndSend()ë©”ì†Œë“œëŠ” ê°™ì€ì´ë¦„ì˜Â `JmsTemplate`ë©”ì†Œë“œì™€ ìœ ì‚¬í•˜ë‹¤.

ì°¨ì´ì : ì§€ì •ëœ íë‚˜ í† í”½ì—ë§Œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í–ˆë˜Â `JmsTemplate`ë©”ì†Œë“œì™€ ë‹¬ë¦¬Â `RabbitTemplate`ë©”ì†Œë“œëŠ” Exchangeì™€ Routing Keyì˜ í˜•íƒœë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•œë‹¤.

`RabbitTemplate`ì„ ì‚¬ìš©í•œ ë©”ì‹œì§€ ì „ì†¡ì— ê°€ì¥ ìœ ìš©í•œ ë©”ì†Œë“œë¥¼ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

```java
// ì›ì‹œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•œë‹¤
void send(Message message) throws AmqpException;
void send(String routingKey, Message message) throws AmqpException;
void send(String exchange, String routingKey, Message message) throws AmqpException;

// ê°ì²´ë¡œë¶€í„° ë³€í™˜ëœ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•œë‹¤.
// 2) ë©”ì†Œë“œëŠ” ì „ì†¡ì— ì•ì„œ ë‚´ë¶€ì ìœ¼ë¡œ ë©”ì‹œì§€ë¡œ ë³€í™˜ë  ê°ì²´ë¥¼ ì¸ìë¡œ ë°›ìŒ
void convertAndSend(Object message) throws AmqpException;
void convertAndSend(String routingKey, Object message) throws AmqpException;
void convertAndSend(String exchange, String routingKey, Object message) throws AmqpException;

// ê°ì²´ë¡œë¶€í„° ë³€í™˜ë˜ê³  í›„ì²˜ë¦¬(post-processing)ë˜ëŠ” ë©”ì‹œì§€ë¥¼ ì „ì†¡í•œë‹¤
// 3) ë¸Œë¡œì»¤ì—ê²Œ ì „ì†¡ë˜ê¸° ì „ì— Message ê°ì²´ë¥¼ ì¡°ì‘í•˜ëŠ”ë° ì‚¬ìš©ë  ìˆ˜ ìˆëŠ”Â MessagePostProcessorì¸ìë¥¼ ë°›ëŠ”ë‹¤.
void convertAndSend(Object message, MessagePostProcessor messagePostProcesser) throws AmqpException;
void convertAndSend(String routingKey, Object message, MessagePostProcessor messagePostProcesser) throws AmqpException;
void convertAndSend(String exchange, String routingKey, Object message, MessagePostProcessor messagePostProcessor) throws AmqpException;
```

ì´ ë©”ì†Œë“œë“¤ì€ JmsTemplateì˜ ëŒ€ì‘ë˜ëŠ” ë©”ì†Œë“œì™€ ìœ ì‚¬í•œ íŒ¨í„´ì„ ë”°ë¥¸ë‹¤.

1) `send()` : ì›ì‹œÂ `Message`ê°ì²´ë¥¼ ì „ì†¡í•œë‹¤.

2) `convertAndSend()`Â : ì „ì†¡ì— ì•ì„œ ë‚´ë¶€ì ìœ¼ë¡œ ë©”ì‹œì§€ë¡œ ë³€í™˜ë  ê°ì²´ë¥¼ ì¸ìë¡œ ë°›ëŠ”ë‹¤.

3) `convertAndSend()`Â : ë¸Œë¡œì»¤ì—ê²Œ ì „ì†¡ë˜ê¸° ì „ì— Message ê°ì²´ë¥¼ ì¡°ì‘í•˜ëŠ”ë° ì‚¬ìš© ë  ìˆ˜ ìˆëŠ”Â `MessagePostProcessor`ì¸ìë¥¼ ë°›ëŠ”ë‹¤.

- ì´ ë©”ì†Œë“œë“¤ì€ ë„ì°©ì§€ì´ë¦„(ë˜ëŠ” Destinationê°ì²´) ëŒ€ì‹ , exchangeì™€ ë¼ìš°íŒ… í‚¤ë¥¼ ì§€ì •í•˜ëŠ” ë¬¸ìì—´ ê°’ì„ ì¸ìë¡œ ë°›ëŠ”ë‹¤ëŠ” ì ì—ì„œ JmsTemplateì˜ ëŒ€ì‘ë˜ëŠ” ë©”ì†Œë“œë“¤ê³¼ ë‹¤ë¥´ë‹¤.
- exchangeë¥¼ ì¸ìë¡œ ë°›ì§€ ì•ŠëŠ” ë©”ì†Œë“œë“¤ì€ ê¸°ë³¸ exchangeë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•œë‹¤.
- ë§ˆì°¬ê°€ì§€ë¡œ ë¼ìš°íŒ… í‚¤ë¥¼ ì¸ìë¡œ ë°›ì§€ ì•ŠëŠ” ë©”ì†Œë“œë“¤ì€ ê¸°ë³¸ ë¼ìš°íŒ… í‚¤ë¡œ ì „ì†¡ë˜ëŠ” ë©”ì‹œì§€ë¥¼ ê°–ëŠ”ë‹¤.

### #. `RabbitTemplate`ì„ ì‚¬ìš©í•´ íƒ€ì½” ì£¼ë¬¸ë°ì´í„°ë¥¼ ì „ì†¡

**`RabbitTemplate.send()`: ë©”ì‹œì§€ ì „ì†¡í•˜ê¸°**

```java
@Service
public class RabbitOrderMessagingService implements OrderMessagingService{
    private RabbitTemplate rabbit;

    @Autowired
    public RabbitOrderMessagingService(RabbitTemplate rabbit){
        this.rabbit=rabbit;
    }

    public void sendOrder(Order order){
        MessageConverter converter= rabbit.getMessageConverter();  
				// 1) getMessageConverter(): ****ë©”ì‹œì§€ ë³€í™˜ê¸° // Orderê°ì²´ë¥¼ Messageê°ì²´ë¡œ ë³€í™˜
        MessageProperties props=new MessageProperties();  // 2) 
        Message message= converter.toMessage(order,props);
        rabbit.send("tacocloud.order", message);  // 3) Message Convert ì™„ë£Œ í›„ send()
    }
}
```

Orderê°ì²´ë¥¼ Messageê°ì²´ë¡œ ë³€í™˜í›„ send()ë¥¼ í˜¸ì¶œí•´ì•¼í•œë‹¤. 

1) MessageConverterê°€ ìˆìœ¼ë©´ Orderê°ì²´ë¥¼ Messageê°ì²´ë¡œ ë³€í™˜í•˜ê¸° ì‰½ë‹¤.

2) ë©”ì‹œì§€ ì†ì„±ì€ **`MessageProperties`**ë¥¼ ì‚¬ìš©í•´ì„œ ì œê³µí•´ì•¼ í•œë‹¤. ê·¸ëŸ¬ë‚˜ ë©”ì‹œì§€ ì†ì„±ì„ ì„¤ì •í•  í•„ìš”ê°€ ì—†ë‹¤ë©´ MessagePropertiesì˜ ê¸°ë³¸ ì¸ìŠ¤í„´ìŠ¤ë§Œìœ¼ë¡œ ì¶©ë¶„í•˜ë‹¤.

3) ëª¨ë“  ì¤€ë¹„ê°€ ì™„ë£Œë˜ë©´ send()ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆë‹¤. ì´ë•Œ ë©”ì‹œì§€ì™€ í•¨ê»˜ exchange ë° ë¼ìš°íŒ… í‚¤ë¥¼ ì¸ìë¡œ ì „ë‹¬í•œë‹¤.

- ìœ„ì˜ ì˜ˆì—ì„œëŠ” `tacocloud.order`ë§Œ ì¸ìë¡œ ì „ë‹¬í•˜ë¯€ë¡œ ê¸°ë³¸ exchangeê°€ ì‚¬ìš©ëœë‹¤. ê¸°ë³¸ exchangeì˜ ì´ë¦„ì€ ë¹ˆ ë¬¸ìì—´ì¸ ""ì´ë©°,
- ì´ê²ƒì€ RabbitMQ ë¸Œë¡œì»¤ê°€ ìë™ìœ¼ë¡œ ìƒì„±í•˜ëŠ” ê¸°ë³¸ exchangeì™€ ì¼ì¹˜í•œë‹¤. ì´ì™€ ë™ì¼í•˜ê²Œ ê¸°ë³¸ ë¼ìš°íŒ… í‚¤ë„ ""ì´ë‹¤.
- ì´ëŸ° ê¸°ë³¸ê°’ì€ spring.rabbitmq.template.exchangeì™€ spring.rabbitmq.template.routing-key ì†ì„±ì„ ì„¤ì •í•´ ë³€ê²½í• ìˆ˜ìˆë‹¤.

**RabbitMQ í™˜ê²½ ì„¤ì •**

```java
spring:
  rabbitmq:
    template:
      exchange: tacocloud.orders    -- 1) exchangeë¥¼ ì§€ì •í•˜ì§€ ì•Šì€ ëª¨ë“  ë©”ì‹œì§€ëŠ” ì´ë¦„ì´ tacocloud.ordersì¸ exchangeë¡œ ìë™ ì „ì†¡ëœë‹¤.
      routing-key: kitchens.central -- 2) ë¼ìš°íŒ… í‚¤ê°€ ì§€ì •ë˜ì§€ ì•Šìœ¼ë©´ í•´ë‹¹ ë©”ì‹œì§€ëŠ” kitchens.centralì„ ë¼ìš°íŒ…í‚¤ë¡œ ì„¤ì •ëœë‹¤.
```

1) exchangeë¥¼ ì§€ì •í•˜ì§€ ì•Šì€ ëª¨ë“  ë©”ì‹œì§€ëŠ” ì´ë¦„ì´ tacocloud.ordersì¸ exchangeë¡œ ìë™ ì „ì†¡ëœë‹¤.

2) send()ë‚˜ convertAndSend()ë¥¼ í˜¸ì¶œí• ë•Œ ë¼ìš°íŒ… í‚¤ê°€ ì§€ì •ë˜ì§€ ì•Šìœ¼ë©´ í•´ë‹¹ ë©”ì‹œì§€ëŠ” kitchens.centralì„ ë¼ìš°íŒ…í‚¤ë¡œ ì„¤ì •ëœë‹¤.

ë©”ì‹œì§€ ë³€í™˜ê¸°ë¡œ Message ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì€ ë§¤ìš° ì‰½ë‹¤. ê·¸ëŸ¬ë‚˜ ëª¨ë“  ë³€í™˜ ì‘ì—…ì„ RabbitTemplateì´ ì²˜ë¦¬í•˜ë„ë¡ convertAndSend()ë¥¼ ì‚¬ìš©í•˜ë©´ í›¨ì”¬ì‰½ë‹¤,

```java
public void sendOrder(Order order){
    rabbit.convertAndSend("tacocloud.order",order);
}
```

## 2.2.1. ë©”ì‹œì§€ ë³€í™˜ê¸° êµ¬ì„±í•˜ê¸°

ê¸°ë³¸ì ìœ¼ë¡œ ë©”ì‹œì§€ ë³€í™˜ì€Â `SimpleMessageConverter`ë¡œ ìˆ˜í–‰ë˜ë©°, ì´ê²ƒì€ Stringê³¼ ê°™ì€ ê°„ë‹¨í•œ íƒ€ì…ê³¼Â `Serializable`ê°ì²´ë¥¼Â `Message`ê°ì²´ë¡œ

ë³€í™˜í•  ìˆ˜ ìˆë‹¤. ê·¸ëŸ¬ë‚˜ ìŠ¤í”„ë§ì€ ë‹¤ìŒì„ í¬í•¨í•´ì„œ RabbitTemplateì— ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì—¬ëŸ¬ê°œì˜ ë©”ì‹œì§€ ë³€í™˜ê¸°ë¥¼ ì œê³µí•œë‹¤.

- **Jackson2JsonMessageConverter**: Jackson2JSONProcessorë¥¼ ì‚¬ìš©í•´ì„œ ê°ì²´ë¥¼ JSONìœ¼ë¡œ ìƒí˜¸ ë³€í™˜í•œë‹¤
- **MarshallingMessageConverter**: ìŠ¤í”„ë§ Marshallerì™€ Unmarshallerë¥¼ ì‚¬ìš©í•´ì„œ ë³€í™˜í•œë‹¤
- **SerializerMessageConverter**: ìŠ¤í”„ë§ì˜ Serializerì™€ Deserializerë¥¼ ì‚¬ìš©í•´ì„œ Stringê³¼ ê°ì²´ë¥¼ ë³€í™˜í•œë‹¤
- **SimpleMessageConverter**: String, byteë°°ì—´,Serializableíƒ€ì…ì„ ë³€í™˜í•œë‹¤
- **ContentTypeDelegatingMessageConverter**: contentType í—¤ë”ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹¤ë¥¸ ë©”ì‹œì§€ ë³€í™˜ê¸°ì— ë³€í™˜ì„ ìœ„ì„í•œë‹¤.

ë©”ì‹œì§€ ë³€í™˜ê¸°ë¥¼ ë³€ê²½í•  ë•ŒëŠ”Â `MessageConverter`íƒ€ì…ì˜ ë¹ˆì„ êµ¬ì„±í•˜ë©´ ëœë‹¤. ì˜ˆë¥¼ë“¤ì–´, JSONê¸°ë°˜ ë©”ì‹œì§€ ë³€í™˜ì˜ ê²½ìš°ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

```java
@Bean
public MessageConverter messageConverter(){
    return new Jackson2JsonMessageConverter();
}
```

- ì´ë ‡ê²Œ í•˜ë©´ ìŠ¤í”„ë§ ë¶€íŠ¸ ìë™êµ¬ì„±ì—ì„œ ì´ ë¹ˆì„ ì°¾ì•„ì„œ ê¸°ë³¸ ë©”ì‹œì§€ ë³€í™˜ê¸° ëŒ€ì‹  ì´ ë¹ˆì„ RabbitTemplateìœ¼ë¡œ ì£¼ì…í•œë‹¤

## 2.2.2. ë©”ì‹œì§€ ì†ì„± ì„¤ì •í•˜ê¸°

JMSì—ì„œ ì²˜ëŸ¼ ì „ì†¡í•˜ëŠ” ë©”ì‹œì§€ì˜ ì¼ë¶€ í—¤ë”ë¥¼ ì„¤ì •í•´ì•¼ í•  ê²½ìš°ê°€ ìˆë‹¤. ì´ë•ŒëŠ” Messageê°ì²´ë¥¼ ìƒì„±í• ë•Œ ë©”ì‹œì§€ ë³€í™˜ê¸°ì— ì œê³µí•˜ëŠ” MessagePropertiesì¸ìŠ¤í„´ìŠ¤ë¥¼ í†µí•´ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

```java
public void sendOrder(Order order) {
    MessageConverter converter = rabbit.getMessageConverter();
    MessageProperties props = new MessageProperties();
    props.setHeader("X_ORDER_SOURCE", "WEB");
    Message message = converter.toMessage(order, props);
    rabbit.send("tacocloud.order", message);
}
```

ê·¸ëŸ¬ë‚˜ convertAndSend()ë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” **MessageProperties** ê°ì²´ë¥¼ ì§ì ‘ ì‚¬ìš©í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ë‹¤ìŒê³¼ ê°™ì´ MessagePostProcessorë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

```java
public void sendOrder(Order order) {
	rabbit.convertAndSend("tacocloud.order.queue", order, new MessagePostProcessor() {
    @Override
    public Message postProcessMessage(Message message)
            throws AmqpException {
        MessageProperties props = message.getMessageProperties();
        props.setHeader("X_ORDER_SOURCE", "WEB");
        return message;
    }
});
```

- **MessagePostProcessor**ë¥¼ êµ¬í˜„í•œ ìµëª…ì˜ ë‚´ë¶€ í´ë˜ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ë¥¼ **convertAndSend**()ì˜ ì¸ìë¡œ ì „ë‹¬í•œë‹¤.
- **postProcessMessage()** ë©”ì„œë“œì—ì„œëŠ” Message ê°ì²´ì˜ MessagePropertiesë¥¼ ê°€ì ¸ì˜¨ í›„ setHeader()ë¥¼ í˜¸ì¶œí•˜ì—¬ X_ORDER_SOURCE í—¤ë”ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

# 2.3. RabbitMQë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹ í•˜ê¸°

JMSì—ì„œì²˜ëŸ¼ RabbitMQì˜ ê²½ìš°ë„ ë‹¤ìŒ ë‘ê°€ì§€ ë°©ë²•ì„ ì„ íƒí•  ìˆ˜ ìˆë‹¤.

- **Pull**: RabbitTemplateì„ ì‚¬ìš©í•´ì„œ íë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜¨ë‹¤
- **Push**: @RabbitListenerê°€ ì§€ì •ëœ ë©”ì†Œë“œë¡œ ë©”ì‹œì§€ê°€ í‘¸ì‹œëœë‹¤.

ìš°ì„  íë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜¤ëŠ” í’€ ëª¨ë¸ ê¸°ë°˜ì˜ RabbitTemplate.receive()ë©”ì†Œë“œë¶€í„° ì•Œì•„ë³´ì.

## 2.3.1. RabbitTemplateì„ ì‚¬ìš©í•´ì„œ ë©”ì‹œì§€ ìˆ˜ì‹ í•˜ê¸°

RabbitTemplateì€ íë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì—¬ëŸ¬ ë©”ì†Œë“œë¥¼ ì œê³µí•œë‹¤.

```java
//ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•œë‹¤
Message receive() throws AmqpException;
Message receive(String queueName) throws AmqpException;
Message receive(long timeoutMillis) throws AmqpException;
Message receive(String queueName, long timeoutMillis) throws AmqpException;

//ë©”ì‹œì§€ë¡œë¶€í„° ë³€í™˜ëœ ê°ì²´ë¥¼ ìˆ˜ì‹ í•œë‹¤
Object receiveAndConvert() throws AmqpException;
Object receiveAndConvert(String queueName) throws AmqpException;
Object receiveAndConvert(long timeoutMillis) throws AmqpException;
Object receiveAndConvert(String queueName, long timeoutMillis) throws AmqpException;

//ë©”ì‹œì§€ë¡œë¶€í„° ë³€í™˜ëœ íƒ€ì…-ì•ˆì „(type-safe)ê°ì²´ë¥¼ ìˆ˜ì‹ í•œë‹¤
<T> T receiveAndConvert(ParameterizedTypeReference<T> type) throws AmqpException;
<T> T receiveAndConvert(String queueName, ParameterizedTypeReference<T> type) throws AmqpException;
<T> T receiveAndConvert(long timoutMillis, ParameterizedTypeRefercence<T> type) throws AmqpException;
<T> T receiveAndConvert(String queueName, long timeoutMillis, ParameterizedTypeReference<T> type) throws AmqpException;
```

ìœ„ëŠ” send() ë° convertAndSend() ë©”ì†Œë“œë“¤ê³¼ ëŒ€ì¹­ëœë‹¤.

- send()ê°€ ì›ì‹œ Message ê°ì²´ë¥¼ ì „ì†¡
- receive()ëŠ” íë¡œë¶€í„° ì›ì‹œ Messageê°ì²´ë¥¼ ìˆ˜ì‹ 

ë§ˆì°¬ê°€ì§€ë¡œ receiveAndConvert()ëŠ” ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•œ í›„ ë©”ì‹œì§€ ë³€í™˜ê¸°ë¥¼ ì‚¬ìš©í•´ ìˆ˜ì‹ ë©”ì‹œì§€ë¥¼ ë„ë©”ì¸ê°ì²´ë¡œ ë³€í™˜í•˜ê³  ë°˜í™˜í•œë‹¤.

- But, ë©”ì†Œë“œ ë§¤ê°œë³€ìˆ˜ì—ì„œ ë¶„ëª…í•œ ì°¨ì´ê°€ ìˆë‹¤.
    - exchangeë‚˜ routing Keyë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ ê°–ì§€ì•ŠëŠ”ë‹¤.
        - exchangeë‚˜ routing KeyëŠ” ë©”ì‹œì§€ë¥¼ íë¡œ ì „ë‹¬í•˜ëŠ”ë° ì‚¬ìš©ë˜ì§€ë§Œ, ì¼ë‹¨ ë©”ì‹œì§€ê°€ íì— ë“¤ì–´ê°€ë©´ ë‹¤ìŒ ë©”ì‹œì§€ ë„ì°©ì§€ëŠ” íë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ì†Œë¹„í•˜ëŠ” Consumerì´ê¸° ë•Œë¬¸ì´ë‹¤.
    - ë”°ë¼ì„œ ë©”ì‹œì§€ë¥¼ ì†Œë¹„í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì€ exchange ë° ë¼ìš°íŒ… í‚¤ë¥¼ ì‹ ê²½ ì“¸ í•„ìš”ì—†ê³  Queueë§Œ ì•Œë©´ëœë‹¤.

## 2.3.2. ë¦¬ìŠ¤ë„ˆë¥¼ ì‚¬ìš©í•´ì„œ RabbitMQ ë©”ì‹œì§€ ì²˜ë¦¬í•˜ê¸°

```java
@Component
public class RabbitOrderReceiver{
    private RabbitTemplate rabbit;
    private MessageConverter converter;

    @Autowired
    public RabbitOrderReceiver(RabbitTemplate rabbit) { // 0) RabbitTemplate , MessageConverter ì£¼ì…
        this.rabbit = rabbit;
        this.converter = rabbit.getMessageConverter();
    }

    public Order receiveOrder(){
        Message message = rabbit.receive("tacocloud.order");  // 1) tacocloud.orders Queueë¡œë¶€í„° ì£¼ë¬¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´
        return message != null ? (Order) converter.fromMessage(message) : null;  // 2) converë¥¼ í†µí•´ Order ê°ì²´ë¡œ ë³€í™˜
    }
}
```

receiveOrder() ë©”ì†Œë“œì—ì„œ ëª¨ë“ ê²ƒì„ ì²˜ë¦¬í•œë‹¤.

0) RabbitTemplate , MessageConverter ì£¼ì…

1) ì£¼ì…ëœ RabbitTemplateì˜ `receive()`ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ tacocloud.orders Queueë¡œë¶€í„° ì£¼ë¬¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ë‹¤.

- Timeout ê°’ì„ ì¸ìë¡œ ì „ë‹¬í•˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ë°”ë¡œ Message ê°ì²´ ë˜ëŠ” null ê°’ì´ ë°˜í™˜ëœë‹¤.
- ëŒ€ê¸°ì‹œê°„(timeoutMillis)ìœ¼ë¡œ 10ì´ˆ ê¸°ë‹¤ë¦¬ê¸°ë¡œ ê²°ì •í–ˆë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ receive()ë©”ì†Œë“œì˜ ì¸ìë¡œ 10,000msë¥¼ ì „ë‹¬í•˜ì—¬ receiveOrder() ë©”ì†Œë“œë¥¼ ë³€ê²½ í•˜ë©´ëœë‹¤.

2) Messageê°ì²´ê°€ ë°˜í™˜ë˜ë©´ RabbitTemplateì˜ MessageConverterë¥¼ ì‚¬ìš©í•˜ì—¬ Message ê°ì²´ë¥¼ Orderê°ì²´ë¡œ ë³€í™˜í•œë‹¤.

**ëŒ€ê¸°ì‹œê°„(timeoutMillis) ì„¤ì •í•˜ê¸°**

```java
public Order receiveOrder(){
    Message message = rabbit.receive("tacocloud.order.queue", 10000);  // <= 10ì´ˆ ëŒ€ê¸°
    return message != null ? (Order) converter.fromMessage(message) :null;
}
```

í•˜ì§€ë§Œ ì´ì²˜ëŸ¼ í•˜ë“œì½”ë”©ëœ ìˆ«ìëŠ” ì‹¬ê¸°ê°€ ë¶ˆí¸.

ì´ë•Œ ìŠ¤í”„ë§ ë¶€íŠ¸ êµ¬ì„±ì†ì„±ìœ¼ë¡œ Timeoutì„ êµ¬ì„±í•  ìˆ˜ ìˆê²ŒÂ `@ConfigurationProperties`Â ì• ë…¸í…Œì´ì…˜ì´ ì§€ì •ëœ í´ë˜ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì´ ì¢‹ê² ë‹¤ëŠ” ìƒê°ì´ ë“¤ ìˆ˜ ìˆë‹¤.

ê·¸ëŸ¬ë‚˜ ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ”ì´ë¯¸ ì´ë¥¼ ì œê³µí•œë‹¤. ë”°ë¡œ `@ConfigurationProperties`Â ë¥¼ ì„¤ì •í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

ë”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •í•˜ë©´ëœë‹¤

**application.yml: ëŒ€ê¸°ì‹œê°„(timeoutMillis) ì„¤ì •í•˜ê¸°**

```java
spring:
  rabbitmq:
    template:
      receive-timeout: 10000
```

receiveOrder() ë©”ì†Œë“œë¥¼ ë‹¤ì‹œ ë³´ë©´ RabbitTemplateì˜ ë©”ì‹œì§€ ë³€í™˜ê¸°ë¥¼ ì‚¬ìš©í•´ ìˆ˜ì‹  Message ê°ì²´ë¥¼ Orderê°ì²´ë¡œ ë³€í™˜í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

`receiveAndConvert()`ë©”ì†Œë“œê°€ ìˆëŠ” ì´ìœ ê°€ ë°”ë¡œ ê·¸ ë•Œë¬¸ì´ë‹¤.

`receiveAndConvert()`ë¥¼ ì‚¬ìš©í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ë©”ì‹œì§€ë¥¼ ìë™ ë³€í™˜í•  ìˆ˜ ìˆë‹¤.

**receiveAndConvert(): ë©”ì‹œì§€ë¡œ ìë™ ë³€í™˜, converter ì‚¬ìš©í•˜ì§€ ì•ŠìŒ**

```java
public Order receiveOrder(){
    return (Order) rabbit.receiveAndConvert("tacocloud.order.queue");  // <= messageë¡œ ìë™ ë³€í™˜
}
```

ì´ ì½”ë“œê°€ í›¨ì”¬ ë” ê°„ë‹¨í•˜ë‹¤. ë‹¨ì§€ Objectíƒ€ì…ì„ Orderíƒ€ì…ìœ¼ë¡œ ìºìŠ¤íŒ…í•˜ëŠ” ê²ƒë§Œ ê³ ë ¤í•˜ë©´ëœë‹¤.

ê·¸ëŸ¬ë‚˜ ìºìŠ¤íŒ… ë§ê³ ë„ ë‹¤ë¥¸ë°©ë²•ì´ ìˆë‹¤. ì¦‰,Â `ParameterizedTypeReference`ë¥¼ receiveAndConvert()ì˜ ì¸ìë¡œ ì „ë‹¬í•˜ì—¬ ì§ì ‘ Orderê°ì²´ë¥¼ ìˆ˜ì‹ í•˜ê²Œ í•˜ëŠ”ê²ƒì´ë‹¤.

```java
public Order receiveOrder(){
    return rabbit.receiveAndConvert("tacocloud.order.queue", 
        new ParameterizedTypeReference<Order>(){});
}
```

- íƒ€ì…-ì•ˆì „ ì¸¡ë©´ì—ì„œ ìºìŠ¤íŒ…ë³´ë‹¤ ì¢‹ë‹¤.
- ë‹¨, receiveAndConvert()ì— ParameterizedTypeReferenceë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë©”ì‹œì§€ ë³€í™˜ê¸°ê°€ SmartMessageConverter ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ í´ë˜ìŠ¤ (Jackson2MessageConverter ë“±)ì´ì–´ì•¼ í•œë‹¤.

## 2.3.2.  ë¦¬ìŠ¤ë„ˆë¥¼ ì‚¬ìš©í•´ì„œ RabbitMQ ë©”ì‹œì§€ ì²˜ë¦¬í•˜ê¸°

ë©”ì‹œì§€ ê¸°ë°˜ì˜ RabbitMQ ë¹ˆì„ ìœ„í•´ì„œ ìŠ¤í”„ë§ì„Â `RabbitListener`ë¥¼ ì œê³µí•œë‹¤.

ë©”ì‹œì§€ê°€ íì— ë„ì°©í•  ë•Œ ë©”ì†Œë“œê°€ ìë™ í˜¸ì¶œë˜ë„ë¡ ì§€ì •í•˜ê¸° ìœ„í•´ì„œëŠ”Â `@RabbitListener`ì• ë…¸í…Œì´ì…˜ì„ RabbitMQë¹ˆì˜ ë©”ì†Œë“œì— ì§€ì •í•´ì•¼í•œë‹¤.

**RabbitMQ Message ë¦¬ìŠ¤ë„ˆë¡œ ë©”ì†Œë“œë¥¼ ì„ ì–¸í•˜ê¸°**

```java
@Component
public class OrderListener{
    private KitchenUI ui;

    @Autowired
    public OrderListener(KitchenUI ui){
        this.ui=ui;
    }
    @RabbitListener(queues="tacocloud.order.queue")
    public void receiveOrder(Order order){
        ui.displayOrder(order);
    }
}
```

ê¸°ì¡´ì˜ ë¦¬ìŠ¤ë„ˆ ì• ë…¸í…Œì´ì…˜ì„ @JmsListener ì—ì„œ @RabbitListenerë¡œ ë³€ê²½í–ˆëŠ”ë°.

ì‚¬ìš©í•˜ëŠ” ë©”ì‹œì§€ ë¸Œë¡œì»¤ì™€ ë¦¬ìŠ¤ë„ˆê°€ ë‹¤ë¥´ë”ë¼ë„ ë¦¬ìŠ¤ë„ˆ ì• ë…¸í…Œì´ì…˜ë§Œ ë³€ê²½í•˜ë©´ ì´ì²˜ëŸ¼ ê±°ì˜ ë™ì¼í•œ ì½”ë“œë¥¼ ì‚¬ìš©í• ìˆ˜ìˆë‹¤.

ì‹¤ì œë¡œ @RabbitListenerëŠ” @JmsListenerì™€ ê±°ì˜ ë™ì¼í•˜ê²Œ ì‘ë™í•œë‹¤.

ë”°ë¼ì„œ ì„œë¡œ ë‹¤ë¥¸ ë©”ì‹œì§€ ë¸Œë¡œì»¤ì¸ RabbitMQ, Artemis, ActiveMQë¥¼ ì‚¬ìš©í•˜ëŠ” ì½”ë“œë¥¼ ì‘ì„±í•  ë•Œ ì™„ì „íˆ ë‹¤ë¥¸ í”„ë¡œê·¸ë˜ë°ì„ ë°°ìš¸ í•„ìš” ì—†ë‹¤.

# ğŸ“˜ 3. ì¹´í”„ì¹´ ì‚¬ìš©í•˜ê¸°

---

- pub-subëª¨ë¸ì˜ Message Queue
- ì•„íŒŒì¹˜ ì¹´í”„ì¹´ëŠ” ê°€ì¥ ìƒˆë¡œìš´ ë©”ì‹œì§• ì‹œìŠ¤í…œì´ë©° ActiveMQ, Artemis, RabbitMQì™€ ìœ ì‚¬í•œ ë©”ì‹œì§€ ë¸Œë¡œì»¤ì´ë‹¤. ê·¸ëŸ¬ë‚˜ ì¹´í”„ì¹´ëŠ” íŠ¹ìœ ì˜ ì•„í‚¤í…ì²˜ë¥¼ ê°–ê³ ìˆë‹¤.
- ì¹´í”„ì¹´ëŠ” ë†’ì€ í™•ì¥ì„±ì„ ì œê³µí•˜ëŠ” í´ëŸ¬ìŠ¤í„°ë¡œ ì‹¤í–‰ë˜ë„ë¡ ì„¤ê³„ë˜ì—ˆë‹¤.
- í´ëŸ¬ìŠ¤í„°ì˜ ëª¨ë“  ì¹´í”„ì¹´ ì¸ìŠ¤í„´ìŠ¤ì— ê±¸ì³ í† í”½ì„ íŒŒí‹°ì…˜ìœ¼ë¡œ ë¶„í• í•˜ì—¬ ë©”ì‹œì§€ë¥¼ ê´€ë¦¬í•œë‹¤.
- RabbitMQê°€ exchangeì™€ íë¥¼ ì‚¬ìš©í•´ì„œ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë°˜ë©´, ì¹´í”„ì¹´ëŠ” í† í”½ë§Œ ì‚¬ìš©í•œë‹¤.
- ì¹´í”„ì¹´ì˜ í† í”½ì€ í´ëŸ¬ìŠ¤í„°ì˜ ëª¨ë“  ë¸Œë¡œì»¤ì— ê±¸ì³ ë³µì œëœë‹¤.
- í´ëŸ¬ìŠ¤í„°ì˜ ê° ë…¸ë“œëŠ” í•˜ë‚˜ ì´ìƒì˜ í† í”½ì— ëŒ€í•œ ë¦¬ë”ë¡œ ë™ì‘í•˜ë©°, í† í”½ë°ì´í„°ë¥¼ ê´€ë¦¬í•˜ê³  í´ëŸ¬ìŠ¤í„°ì˜ ë‹¤ë¥¸ ë…¸ë“œë¡œ ë°ì´í„°ë¥¼ ë³µì œí•œë‹¤. ê° í† í”½ì€ ì—¬ëŸ¬ê°œì˜ íŒŒí‹°ì…˜ìœ¼ë¡œ ë¶„í• ë  ìˆ˜ ìˆë‹¤.
- ì´ ê²½ìš° í´ëŸ¬ìŠ¤í„°ì˜ ê° ë…¸ë“œëŠ” í•œí† í”½ì˜ í•˜ë‚˜ ì´ìƒì˜ íŒŒí‹°ì…˜ì˜ ë¦¬ë”ê°€ ëœë‹¤.

### **Pub-Sub ëª¨ë¸**

ì¹´í”„ì¹´ëŠ” pub-sub(ë°œí–‰/êµ¬ë…) ëª¨ë¸ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì—, ë°œí–‰/êµ¬ë…ëª¨ë¸ì´ ë­”ì§€ ì•Œì•„ë³´ì.

pub-subì€ ë©”ì„¸ì§€ë¥¼ íŠ¹ì • ìˆ˜ì‹ ìì—ê²Œ ì§ì ‘ì ìœ¼ë¡œ ë³´ë‚´ì£¼ëŠ” ì‹œìŠ¤í…œì´ ì•„ë‹ˆë‹¤.

publisherëŠ” ë©”ì„¸ì§€ë¥¼ topicì„ í†µí•´ì„œ ì¹´í…Œê³ ë¦¬í™” í•œë‹¤. ë¶„ë¥˜ëœ ë©”ì„¸ì§€ë¥¼ ë°›ê¸°ë¥¼ ì›í•˜ëŠ” receiverëŠ” ê·¸ í•´ë‹¹ topicì„ êµ¬ë…(subscribe)í•¨ìœ¼ë¡œì¨ ë©”ì„¸ì§€ë¥¼ ì½ì–´ ì˜¬ ìˆ˜ ìˆë‹¤.

ì¦‰, publisherëŠ” topicì— ëŒ€í•œ ì •ë³´ë§Œ ì•Œê³  ìˆê³ , ë§ˆì°¬ê°€ì§€ë¡œ subscriberë„ topicë§Œ ë°”ë¼ë³¸ë‹¤. publisher ì™€ subscriberëŠ” ì„œë¡œ ëª¨ë¥´ëŠ” ìƒíƒœë‹¤.

ê°€ì¥ ê°„ë‹¨í•œ ì˜ˆì œë¥¼ ë“¤ì–´ë³´ì, ì‹ ë¬¸ì‚¬ì—ì„œ ì‹ ë¬¸ì˜ ì¢…ë¥˜(topic)ì— ë©”ì„¸ì§€ë¥¼ ì“´ë‹¤. ìš°ë¦¬ëŠ” ê·¸ í•´ë‹¹ ì‹ ë¬¸ì„ êµ¬ë…í•œë‹¤.

# 3.0. KAFKA?

[https://medium.com/@umanking/ì¹´í”„ì¹´ì—-ëŒ€í•´ì„œ-ì´ì•¼ê¸°-í•˜ê¸°ì „ì—-ë¨¼ì €-dataì—-ëŒ€í•´ì„œ-ì´ì•¼ê¸°í•´ë³´ì-d2e3ca2f3c2](https://medium.com/@umanking/%EC%B9%B4%ED%94%84%EC%B9%B4%EC%97%90-%EB%8C%80%ED%95%B4%EC%84%9C-%EC%9D%B4%EC%95%BC%EA%B8%B0-%ED%95%98%EA%B8%B0%EC%A0%84%EC%97%90-%EB%A8%BC%EC%A0%80-data%EC%97%90-%EB%8C%80%ED%95%B4%EC%84%9C-%EC%9D%B4%EC%95%BC%EA%B8%B0%ED%95%B4%EB%B3%B4%EC%9E%90-d2e3ca2f3c2)

[https://epicdevs.com/17](https://epicdevs.com/17)

## 3.0.1. **ì¹´í”„ì¹´ì˜ êµ¬ì„±ìš”ì†Œ ë° íŠ¹ì§•**

- topic, partiton
- Producer, Consumer
- broker, zookeepr
- consumer group
- replication
### **Topicê³¼ Partition**

- ì¹´í”„ì¹´ì— ì €ì¥ë˜ëŠ” ë©”ì‹œì§€ëŠ” topicìœ¼ë¡œ ë¶„ë¥˜ë˜ê³ , topicì€ ì—¬ëŸ¬ê°œì˜ patitionìœ¼ë¡œ ë‚˜ëˆ ì§ˆìˆ˜ ìˆë‹¤.
- partitionì•ˆì—ëŠ” messageì˜ ìƒëŒ€ì  ìœ„ì¹˜ë¥¼ ë‚´íƒ€ë‚´ëŠ” offsetì´ ìˆë‹¤.
    - offetì •ë³´ë¥¼ ì´ìš©í•´ ì´ì „ì— ê°€ì ¸ê°„ ë©”ì‹œì§€ì˜ ìœ„ì¹˜ ì •ë³´ë¥¼ ì•Œ ìˆ˜ ìˆê³  ë™ì‹œì— ë“¤ì–´ì˜¤ëŠ” ë§ì€ ë°ì´í„°ë¥¼ ì—¬ëŸ¬ê°œì˜ íŒŒí‹°ì…˜ì— ë‚˜ëˆ„ì–´ ì €ì¥í•˜ê¸° ë•Œë¬¸ì— ë³‘ë ¬ë¡œ ë¹ ë¥´ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.
- ì¹´í”„ì¹´ í´ëŸ¬ìŠ¤í„°ëŠ” ì—¬ëŸ¬ê°œì˜ ë¸Œë¡œì»¤ë¡œ êµ¬ì„±ë˜ë©°, ê° ë¸Œë¡œì»¤ëŠ” í† í”½ì˜ íŒŒí‹°ì…˜ì˜ ë¦¬ë”ë¡œ ë™ì‘í•œë‹¤.
- ë©”ì„¸ì§€ëŠ” topicìœ¼ë¡œ ë¶„ë¥˜ë˜ê³ , topicì€ ì—¬ëŸ¬ê°œì˜ íŒŒí‹°ì…˜ìœ¼ë¡œ ë‚˜ëˆ  ì§ˆ ìˆ˜ ìˆë‹¤. íŒŒí‹°ì…˜ë‚´ì˜ í•œ ì¹¸ì€ ë¡œê·¸ë¼ê³  ë¶ˆë¦°ë‹¤. ë°ì´í„°ëŠ” í•œ ì¹¸ì˜ ë¡œê·¸ì— ìˆœì°¨ì ìœ¼ë¡œ appendëœë‹¤. ë©”ì„¸ì§€ì˜ ìƒëŒ€ì ì¸ ìœ„ì¹˜ë¥¼ ë‚˜íƒ€ë‚´ëŠ”ê²Œ offsetì´ë‹¤.

***ê·¸ëŸ¬ë©´, ì™œ í•˜ë‚˜ì˜ í† í”½ì— ì—¬ëŸ¬ê°œì˜ íŒŒí‹°ì…˜ì„ ë‚˜ëˆ ì„œ ë©”ì„¸ì§€ë¥¼ ì“¸ê¹Œ ?***

- í•˜ë‚˜ì˜ topicì— í•˜ë‚˜ì˜ íŒŒí‹°ì…˜ë§Œ ê°€ì§„ ìƒí™©ê³¼ í•˜ë‚˜ì˜ topicì— ì—¬ëŸ¬ê°œì˜ íŒŒí‹°ì…˜ì„ ê°€ì§„ ë‘ê°€ì§€ë¥¼ ë¹„êµí•´ ë³´ë©´ ëœë‹¤. ë©”ì„¸ì§€ëŠ” ì¹´í”„ì¹´ì˜ í•´ë‹¹ í† í”½ì— ì“°ì—¬ì§„ë‹¤. ì“°ëŠ” ê³¼ì •ë„ ì‹œê°„ì´ ì†Œë¹„ëœë‹¤.
- ëª‡ ì²œê±´ì˜ ë©”ì„¸ì§€ê°€ ë™ì‹œì— ì¹´í”„ì¹´ì— ì“°ì—¬ì§„ë‹¤ê³  ìƒê°í•´ë³´ì. ê·¸ëŸ¬ë©´ í•˜ë‚˜ì˜ íŒŒí‹°ì…˜ì— ìˆœì°¨ì ìœ¼ë¡œ append ë˜ëŠ”ë° ë™ì‹œì— ì²˜ë¦¬ê°€ ì–´ë µë‹¤.
- ë”°ë¼ì„œ ì—¬ëŸ¬ê°œì˜ íŒŒí‹°ì…˜ì„ ë‘ì–´ì„œ ë¶„ì‚°ì €ì¥ì„ í•˜ëŠ” ê²ƒì´ë‹¤. ê·¸ëŸ¬ë©´ ì“°ëŠ” ì²˜ë¦¬ê°€ ë³‘ë ¬ë¡œ ì²˜ë¦¬ë í…Œë‹ˆ ì‹œê°„ì´ ê·¸ë§Œí¼ ì ˆì•½ í•  ìˆ˜ ìˆë‹¤. ë¬¼ë¡  ì¢‹ë‹¤ëŠ” ë§ì€ í•­ìƒ trade-offì´ë‹¤.
- **(ì£¼ì˜)í•œ ë²ˆ ëŠ˜ë¦° íŒŒí‹°ì…˜ì€ ì ˆëŒ€ë¡œ ì¤„ì¼ ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ìš´ì˜ì¤‘ì—, íŒŒí‹°ì…˜ì„ ëŠ˜ë ¤ì•¼ í•˜ëŠ”ê±´ ì¶©ë¶„íˆ ê³ ë ¤í•´ë´ì•¼í•œë‹¤.**
- íŒŒí‹°ì…˜ì„ ëŠ˜ë ¸ì„ ë•Œ ë©”ì„¸ì§€ê°€ Round-robinë°©ì‹ìœ¼ë¡œ ì“°ì—¬ì§„ë‹¤.
    - ì¦‰, ìˆœì°¨ì ìœ¼ë¡œ ë©”ì„¸ì§€ê°€ ì“°ì—¬ì§€ì§€ ì•ŠëŠ”ë‹¤ëŠ” ë§ì´ë‹¤.
    - ì´ ë§ì€, ë‚˜ì¤‘ì— í•´ë‹¹ í† í”½ì„ ì†Œë¹„í•˜ëŠ” ì†Œë¹„ìê°€ ë§Œì•½ì— ë©”ì„¸ì§€ì˜ ìˆœì„œê°€ ì—„ì²­ ì¤‘ìš”í•œ ëª¨ë¸(ì£¼ì‹, ì½”ì¸ exchange)ì´ë¼ë©´ ìˆœì°¨ì ìœ¼ë¡œ ì†Œë¹„ ë¨ì„ ë³´ì¥í•´ ì£¼ì§€ ì•Šê¸° ë•Œë¬¸ì— ìƒë‹¹íˆ ìœ„í—˜í•œ ê²ƒì´ë‹¤.

### **Producer, Consumer**

- ProducerëŠ” ìƒì‚°(ë©”ì‹œì§€ë¥¼ Write)í•˜ëŠ” ì£¼ì²´
- ConsumerëŠ” ì†Œë¹„(ë©”ì‹œì§€ë¥¼ Read)í•˜ëŠ” ì£¼ì²´ì´ë‹¤.
- Producerì™€ Consumerê°„ì—ëŠ” ìƒí˜¸ ì¡´ì¬ ì—¬ë¶€ë¥¼ ì•Œì§€ ëª»í•œì±„ ìì‹ ì—ê²Œ ì£¼ì–´ì§„ ì—­í• ë§Œ ì²˜ë¦¬ í•˜ê²Œ ëœë‹¤. (ìœ„ ê·¸ë¦¼ì—ì„œ ë³´ë©´ Writesê°€ Producer)

### **Consumer Group**

Producerì—ì„œ ìƒì‚°(Write)í•œ ë©”ì‹œì§€ëŠ” ì—¬ëŸ¬ê°œì˜ íŒŒí‹°ì…˜ì— ì €ì¥ì„ í•˜ëŠ”ë°, ê·¸ë ‡ë‹¤ë©´ ì†Œë¹„í•˜ëŠ”(Consumer)í•˜ëŠ” ìª½ì—ì„œë„ ì—¬ëŸ¬ ì†Œë¹„ìê°€ ë©”ì‹œì§€ë¥¼ ì½ì–´ê°€ëŠ”ê²ƒì´ í›¨ì”¬ íš¨ìœ¨ì ì¼ ê²ƒì´ë‹¤. í•˜ë‚˜ì˜ ëª©í‘œë¥¼ ìœ„í•´ ì†Œë¹„ë¥¼Â í•˜ëŠ” ê·¸ë£¹, ì¦‰ í•˜ë‚˜ì˜ í† í”½ì„ ì½ì–´ê°€ê¸° ìœ„í•œ Counsumerë“¤ì„ Consumer Groupë¼ê³  í•œë‹¤.

í•˜ì§€ë§Œ ì´ Consumer Groupì—ëŠ” í•œê°€ì§€ ë£°ì´ ìˆë‹¤. Topicì˜ íŒŒí‹°ì…˜ì€ ê·¸ Consumer Groupê³¼ 1:N ë§¤ì¹­ì´ë‹¤. ì¦‰, ìì‹ ì´ ì½ê³  ìˆëŠ” íŒŒí‹°ì…˜ì—ëŠ” ê°™ì€ ê·¸ë£¹ë‚´ ë‹¤ë¥¸ ì»¨ìŠˆë¨¸ê°€ ì½ì„ ìˆ˜ ì—†ë‹¤.

- íŒŒí‹°ì…˜ì—ëŠ” ë™ì¼í•œ Consumer Groupì„ ìœ„í•œ í•˜ë‚˜ì˜ êµ¬ë©ì´ ìˆê³ , ConsumerëŠ” ê·¸ êµ¬ë©ì— ë¹¨ëŒ€ë¥¼ ê½‚ì•„ ì½ì–´ê°„ë‹¤ê³  ìƒê°í•˜ë©´ ì¢€ ë” ì‰½ê²Œ ì´í•´í•  ìˆ˜ ìˆë‹¤.

**Consumer Groupì´ ì¡´ì¬í•˜ëŠ” ì´ìœ **

- ì»¨ìŠˆë¨¸ ê·¸ë£¹ì€ í•˜ë‚˜ì˜ topicì— ëŒ€í•œ ì±…ì„ì„ ê°–ê³  ìˆë‹¤.
    - ì¦‰, ê°™ì€ ê·¸ë£¹ë‚´ì˜ ì–´ë–¤ ì»¨ìŠˆë¨¸ê°€ downëœë‹¤ë©´, ê±”ê°€ ì›ë˜ íŒŒí‹°ì…˜1ì— ëŒ€í•´ì„œ ì†Œë¹„ë¥¼ ë§¡ì•˜ë˜ ì»¨ìŠˆë¨¸ê°€ íŒŒí‹°ì…˜1ì— ëŒ€í•œ ì†Œë¹„ë¥¼ í•  ìˆ˜ ì—†ëŠ” ìƒí™©ì´ë‹¤.
- ì´ëŸ¬í•œ ìƒí™©ì„ Rebalance ëœ ìƒí™©ì´ë¼ê³  í•œë‹¤.
    - ë¦¬ë°¸ëŸ°ìŠ¤ê°€ ëœ ìƒí™©ì´ë©´, íŒŒí‹°ì…˜ ì¬ì¡°ì •ì„ í†µí•´ì„œ ë‹¤ë¥¸ ì»¨ìŠˆë¨¸ê°€ íŒŒí‹°ì…˜1ì˜ ì†Œë¹„ë¥¼ ì´ì–´ì„œ í•˜ê²Œëœë‹¤.
    - ë¬¼ë¡  ìœ„ì—ì„œ ì„¤ëª…í•œ offset ì •ë³´ë¥¼ ê·¸ë£¹ë‚´ì—ì„œ ì„œë¡œê°„ì˜ ê³µìœ í•˜ê³  ìˆê¸° ë•Œë¬¸ì—, ë»—ê¸° ì§ì „ì˜ offsetìœ„ì¹˜ë¥¼ ì•Œê³  ê·¸ ë‹¤ìŒë¶€í„° ì†Œë¹„í•˜ë©´ ë¬¸ì œê°€ ì—†ì–´ì§€ëŠ” ê²ƒì´ë‹¤.

### **Replication (ë³µì œ)**

ì¹´í”„ì¹´ì—ì„œëŠ” replication ìˆ˜ë¥¼ ì„ì˜ë¡œ ì§€ì •í•˜ì—¬ topicì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤. replication-factorì— ì§€ì •í•˜ëŠ”ë° ë§Œì•½ 3ìœ¼ë¡œ í•˜ë©´ replication ìˆ˜ê°€ 3ì´ ëœë‹¤.

Kafka Clusterì—Â 3ê°œì˜ brokerê°€ ìˆê³ Â 3ê°œì˜ Topicì´ ìˆë‹¤ê³  ê°€ì •í•´ë³´ì.

Topic-1ì€ replication-factor 1, Topic-2ì€ replication-factor 2, Topic-3ì€ replication-factor 3ì¸ ê²½ìš°ì´ë‹¤.

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/1a80c506-18bb-43e9-8e70-32ea3cf154d6/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/1a80c506-18bb-43e9-8e70-32ea3cf154d6/Untitled.png)

- replicationì„ ì¢€ë” ìì„¸íˆ ë“¤ì—¬ë‹¤ë³´ë©´, ë³µì œìš”ì†Œì¤‘ ëŒ€í‘œì¸ leader, ê·¸ì™¸ ìš”ì†Œì¸ followerë¡œ ë‚˜ëˆ„ì–´ì§„ë‹¤. topicìœ¼ë¡œ í†µí•˜ëŠ” ëª¨ë“  ë°ì´í„°ì˜ read/writeëŠ” ì˜¤ì§ leaderì—ì„œ ì´ë£¨ì–´ì§€ê³  followerëŠ” leaderì™€ syncë¥¼ ìœ ì§€í•¨ìœ¼ë¡œì¨ leaderì— ë¬¸ì œê°€ ìƒê²¼ì„ ê²½ìš° followerë“¤ ì¤‘ í•˜ë‚˜ê°€ leaderì—­í• ì„ í•˜ê²Œ ë˜ëŠ” ê²ƒì´ë‹¤.
- ë³µì œëœ ë°ì´í„°ê°€ followerë“¤ì—ê²Œ ìˆìœ¼ë‹ˆ, ë©”ì‹œì§€ì˜ ìœ ì‹¤ì´ ì—†ë‹¤ëŠ” ì¥ì ì´ ìˆì§€ë§Œ, ë³µì œë¥¼ í•˜ê¸° ìœ„í•œ ì‹œê°„ê³¼ ë„¤íŠ¸ì›Œí¬ ë¹„ìš©ì´ ë“¤ê¸° ë•Œë¬¸ì— ë°ì´í„°ì˜ ì¤‘ìš”ë„ì— ë”°ë¼ ackì˜µì…˜ìœ¼ë¡œ ì„±ëŠ¥ê³¼ ë°ì´í„°ì˜ ì¤‘ìš”ë„ì— ë”°ë¼ ë‹¤ìŒê³¼ ê°™ì´ ì„¸ë¶€ì„¤ì •ì´ ê°€ëŠ¥í•˜ë‹¤.

### **Broker, Zookeeper**

**Broker**ëŠ” ì¹´í”„ì¹´ ì„œë²„ë¥¼ ì¹­í•œë‹¤. ì„¤ì •ì„ í†µí•´ ë™ì¼í•œ ë…¸ë“œ ë‚´ì—ì„œ ì—¬ëŸ¬ê°œì˜ brokerì„œë²„ë¥¼ ë„ìš¸ ìˆ˜ ìˆë‹¤.

**Zookeeper**ëŠ” ì´ëŸ¬í•œ ë¶„ì‚° ë©”ì‹œì§€íì˜ ì •ë³´ë¥¼ ê´€ë¦¬í•´ì£¼ëŠ” ì—­í• ì„ í•œë‹¤. ì¹´í”„ì¹´ë¥¼ ë„ìš°ê¸° ìœ„í•´ì„œëŠ” ë°˜ë“œì‹œ ì£¼í‚¤í¼ê°€ ì‹¤í–‰ë˜ì–´ì•¼ í•œë‹¤.

![Ch08/Untitled%203.png](Ch08/Untitled%203.png)

# 3.1. ì¹´í”„ì¹´ ì‚¬ìš©ì„ ìœ„í•´ ìŠ¤í”„ë§ ì„¤ì •í•˜ê¸°

ì¹´í”„ì¹´ë¥¼ ì‚¬ìš©í•´ì„œ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ë ¤ë©´ ì´ì— ì í•©í•œ ì˜ì¡´ì„±ì„ ë¹Œë“œì— ì¶”ê°€í•´ì•¼í•œë‹¤.

- JMSë‚˜ RabbitMQì™€ ë‹¬ë¦¬ ì¹´í”„ì¹´ëŠ” ìŠ¤í”„ë§ ë¶€íŠ¸ ìŠ¤íƒ€í„°ì— í¬í•¨ë˜ì–´ ìˆì§€ ì•Šì§€ë§Œ ì˜ì¡´ì„±ë§Œ ì¶”ê°€í•˜ë©´ ëœë‹¤.

```java
<dependency>
    <groupId>org.springframework.kafka</groupId>
    <artifactId>spring-kafka</artifactId>
</dependency>
```

ì´ì²˜ëŸ¼ ì˜ì¡´ì„±ì„ ì¶”ê°€í•˜ë©´ ìŠ¤í”„ë§ë¶€íŠ¸ê°€ ì¹´í”„ì¹´ ì‚¬ìš©ì„ ìœ„í•œ ìë™-êµ¬ì„±ì„ í•´ì¤€ë‹¤. ë”°ë¼ì„œ ìš°ë¦¬ëŠ”Â `KafkaTemplate`ì„ ì£¼ì…í•˜ê³  ë©”ì‹œì§€ë¥¼ ì „ì†¡, ìˆ˜ì‹ í•˜ë©´ëœë‹¤.

ë©”ì‹œì§€ë¥¼ ì „ì†¡ ë° ìˆ˜ì‹ í•˜ê¸°ì— ì•ì„œ, ì¹´í”„ì¹´ë¥¼ ì‚¬ìš©í•  ë•Œ í¸ë¦¬í•œ ëª‡ê°€ì§€ ì†ì„±ì„ ì•Œì•„ì•¼í•œë‹¤.

`KafkaTemplate`ì€ ê¸°ë³¸ì ìœ¼ë¡œ

localhostì—ì„œ ì‹¤í–‰ë˜ë©´ì„œ 9092í¬íŠ¸ë¥¼ ë¦¬ìŠ¤ë‹í•˜ëŠ” ì¹´í”„ì¹´ ë¸Œë¡œì»¤ë¥¼ ì‚¬ìš©í•œë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ê°œë°œí•  ë•ŒëŠ” ë¡œì»¬ì˜ ì¹´í”„ì¹´ ë¸Œë¡œì»¤ë¥¼ ì‚¬ìš©í•˜ë©´ì¢‹ë‹¤.

spring.kafka.bootstrap-servers ì†ì„±ì—ëŠ” ì¹´í”„ì¹´ í´ëŸ¬ìŠ¤í„°ë¡œì˜ ì´ˆê¸° ì—°ê²°ì— ì‚¬ìš©ë˜ëŠ” í•˜ë‚˜ ì´ìƒì˜ ì¹´í”„ì¹´ ì„œë²„ë“¤ì˜ ìœ„ì¹˜ë¥¼ ì„¤ì •í•œë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, í´ëŸ¬ìŠ¤í„°ì˜ ì¹´í”„ì¹´ ì„œë²„ ì¤‘ í•˜ë‚˜ê°€ kafka.tacocloud.comì—ì„œ ì‹¤í–‰ë˜ê³  9092í¬íŠ¸ë¥¼ ë¦¬ìŠ¤ë‹í•œë‹¤ë©´, ì´ì„œë²„ì˜ ìœ„ì¹˜ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì„±í• ìˆ˜ ìˆë‹¤.

```java
# ì´ìƒì˜ ì„œë²„ë“¤ì˜ ìœ„ì¹˜ë¥¼ ì„¤ì • í•¨.
spring:
  kafka:
    bootstrap-servers:
    - kafka.tacocloud.com:9092
    - kafka.tacocloud.com:9093
    - kafka.tacocloud.com:9094
.....
```

- spring.kafka.bootstrap-serversëŠ” ë³µìˆ˜í˜•ì´ë©° ìœ„ì™€ ê°™ì´ ì„œë²„ë¦¬ìŠ¤íŠ¸ë¥¼ ë°›ìœ¼ë¯€ë¡œ í´ëŸ¬ìŠ¤í„°ì˜ ì—¬ëŸ¬ ì„œë²„ë¥¼ ì§€ì •í• ìˆ˜ìˆë‹¤.

# 3.2. KafkaTemplateì„ ì‚¬ìš©í•´ì„œ ë©”ì‹œì§€ ì „ì†¡í•˜ê¸°

```java
ListenableFuture<SendResult<K, V>> send(String topic, V data);
ListenableFuture<SendResult<K, V>> send(String topic, K key, V data);
ListenableFuture<SendResult<K, V>> send(String topic, Integer partition, K key, V data);
ListenableFuture<SendResult<K, V>> send(String topic, Integer partition, Long timestamp, K key, V data);
// ì‚¬ìš©ì´ ë²ˆê±°ë¡­ë‹¤.
ListenableFuture<SendResult<K, V>> send(ProducerRecord<K, V> record);  // 1)
ListenableFuture<SendResult<K, V>> send(Message<?> message);  // 2)

ListenableFuture<SendResult<K, V>> sendDefault(V data);
ListenableFuture<SendResult<K, V>> sendDefault(K key, V data);
ListenableFuture<SendResult<K, V>> sendDefault(Integer partition, K key, V data);
ListenableFuture<SendResult<K, V>> sendDefault(Integer partition, Long timestamp, K key, V data);
```

- JMS, Rabbitê³¼ ë‹¤ë¥´ê²Œ `convertAndSend()`ë©”ì†Œë“œê°€ ì—†ë‹¤.
    - KafkaTemplateì€ **ì œë„¤ë¦­ íƒ€ì…**ì„ ì‚¬ìš©í•˜ê³ , ë©”ì‹œì§€ë¥¼ ì „ì†¡í•  ë•Œ ì§ì ‘ ë„ë©”ì¸ íƒ€ì…ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤.
    - ë”°ë¼ì„œ ëª¨ë“  send()ë©”ì†Œë“œê°€ convertAndSend()ì˜ ê¸°ëŠ¥ì„ ê°–ê³  ìˆë‹¤.
- ë˜í•œ, `send()`ì™€ `sendDefault()`ì—ëŠ” JMSë‚˜ Rabbitì— ì‚¬ìš©í–ˆë˜ ê²ƒê³¼ ë‹¤ë¥¸ ë§¤ê°œë³€ìˆ˜ë“¤ì´ ìˆë‹¤.
- ì¹´í”„ì¹´ì—ì„œëŠ” ë©”ì‹œì§€ë¥¼ ì „ì†¡í•  ë•ŒëŠ” ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ëŠ” ë°©ë²•ì„ ì•Œë ¤ì£¼ëŠ” ë‹¤ìŒ ë§¤ê°œë³€ìˆ˜ë¥¼ ì§€ì •í•  ìˆ˜ ìˆë‹¤.
- ë©”ì‹œì§€ê°€ ì „ì†¡ë  topic(`send()`ì— í•„ìš”í•¨)
- í† í”½ ë°ì´í„°ë¥¼ ì“°ëŠ” partition(ì„ íƒì ì„)
- ë ˆì½”ë“œ ì „ì†¡ key(ì„ íƒì ì„)
- timestamp(ì„ íƒì ì´ë©° ê¸°ë³¸ê°’ì€ System.currentTimeMillis())
- payload(ë©”ì‹œì§€ì— ì ì¬ëœ ìˆœìˆ˜í•œ ë°ì´í„°(ex. Orderê°ì²´)ì´ë©° í•„ìˆ˜ì„)

- topicê³¼ payloadëŠ” ê°€ì¥ ì¤‘ìš”í•œ ë§¤ê°œë³€ìˆ˜ë“¤ì´ë‹¤.
- partitionê³¼ keyëŠ” send()ì™€ sendDefault()ì— ë§¤ê°œë³€ìˆ˜ë¡œ ì œê³µë˜ëŠ” ì¶”ê°€ ì •ë³´ì¼ ë¿ `KafkaTemplate`ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì—ëŠ” ê±°ì˜ ì˜í–¥ì„ ì£¼ì§€ ì•ŠëŠ”ë‹¤.

1) send()ë©”ì†Œë“œì—ëŠ” ProducerRecordë¥¼ ì „ì†¡í•˜ëŠ” ê²ƒë„ ìˆë‹¤.

- `ProducerRecord`ëŠ” ëª¨ë“  ì„ í–‰ ë§¤ê°œë³€ìˆ˜ë“¤ì„ í•˜ë‚˜ì˜ ê°ì²´ì— ë‹´ì€ íƒ€ì…ì´ë‹¤.

2) Message ê°ì²´ë¥¼ ì „ì†¡í•˜ëŠ” send()ë©”ì†Œë“œë„ ìˆë‹¤.

- ì´ ê²½ìš° ë„ë©”ì¸ ê°ì²´ë¥¼ Messageê°ì²´ë¡œ ë³€í™˜í•´ì•¼í•œë‹¤. ëŒ€ê°œì˜ ê²½ìš°ì— ProducerRecordë‚˜ Messageê°ì²´ë¥¼ ìƒì„± ë° ì „ì†¡í•˜ëŠ” ê²ƒë³´ë‹¤ëŠ” ë‹¤ë¥¸ send()ë©”ì†Œë“œ ì¤‘ í•˜ë‚˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì‰½ë‹¤.

### #. **KafkaTemplateì„ ì‚¬ìš©í•´ì„œ ì£¼ë¬¸ ë°ì´í„° ì „ì†¡í•˜ê¸°**

```java
@Service
public class KafkaOrderMessagingService implements OrderMessagingService{
    private KafkaTemplate<String, Order> kafkaTemplate;

    @Autowired
    public KafkaOrderMessagingService(KafkaTemplate<String, Order> kafkaTemplate){
        this.kafkaTemplate=kafkaTemplate;
    }

    @Override
    public void sendOrder(Order order){
        kafkaTemplate.send("tacocloud.orders.topic",order);
    }
}
```

ì—¬ê¸°ì„œ sendOrder() ë©”ì†Œë“œëŠ” ì£¼ì…ëœ KafkaTemplateì˜ send()ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•´ì„œ tacocloud.orders.topicì´ë¼ëŠ” ì´ë¦„ì˜

í† í”½ìœ¼ë¡œ Orderê°ì²´ë¥¼ ì „ì†¡í•œë‹¤.Â `Kafka`ë¼ëŠ” ë‹¨ì–´ê°€ ì½”ë“œì˜ ì´ê³³ì €ê³³ì— í¬í•¨ëœ ê²ƒ ì™¸ì—ëŠ” JMSì™€ Rabbitì— ì‚¬ìš©í–ˆë˜ ì½”ë“œì™€ í¬ê²Œë‹¤ë¥´ì§€ì•Šë‹¤.

ê¸°ë³¸í† í”½ì„ ì„¤ì •í•œë‹¤ë©´ sendOrder()ë©”ì†Œë“œë¥¼ ì•½ê°„ ë” ê°„ë‹¨í•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆë‹¤. ìš°ì„  spring.kafka.template.default-topicì— ì„¤ì •í•˜ì

```java
spring:
  kafka:
    template:
      default-topic: tacocloud.orders.topic
```

ê·¸ ë‹¤ìŒì— sendOrder()ë©”ì†Œë“œì—ì„œ send()ëŒ€ì‹  sendDefault()ë¥¼ í˜¸ì¶œí•˜ë©´ ëœë‹¤. ì´ë•ŒëŠ” í† í”½ ì´ë¦„ì„ ì¸ìë¡œ ì „ë‹¬í•˜ì§€ ì•ŠëŠ”ë‹¤.

```java
@Override
public void sendOrder(Order order){
    kafkaTemplate.sendDefault(order);
}
```

# 3.3. ì¹´í”„ì¹´ ë¦¬ìŠ¤ë„ˆ ì‘ì„±í•˜ê¸°

send()ì™€ sendDefault()íŠ¹ìœ ì˜ ë©”ì†Œë“œ ì‹œê·¸ë‹ˆì²˜ ì™¸ì—,

KafkaTemplateì€ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ëŠ” ë©”ì†Œë“œë¥¼ ì œê³µí•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì ì—ì„œ JmsTemplateì´ë‚˜ RabbitTemplateê³¼ ë‹¤ë¥´ë‹¤.

- ë”°ë¼ì„œ ìŠ¤í”„ë§ì„ ì‚¬ìš©í•´ì„œ ì¹´í”„ì¹´ í† í”½ì˜ ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜¤ëŠ” ìœ ì¼í•œ ë°©ë²•ì€ ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆë¥¼ ì‘ì„±í•˜ëŠ” ê²ƒì´ë‹¤.

- ì¹´í”„ì¹´ì˜ ê²½ìš° ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆëŠ”Â `@KafkaListener`ì• ë…¸í…Œì´ì…˜ì´ ì§€ì •ëœ ë©”ì†Œë“œì— ì •ì˜ëœë‹¤.

- `@KafkaListener`ëŠ” @JmsListenerë‚˜ @RabbitListenerì™€ ê±°ì˜ ìœ ì‚¬í•˜ë©°, ë™ì¼í•œ ë°©ë²•ìœ¼ë¡œ ì‚¬ìš©ëœë‹¤.

### 3.3.1. @KafkaListenerë¥¼ ì‚¬ìš©í•´ ì£¼ë¬¸ ë°ì´í„° ìˆ˜ì‹ í•˜ê¸°

```java
@Component
public class OrderListener{
    private KitchenUI ui;

    @Autowired
    public OrderListener(KitchenUI ui){
        this.ui=ui;
    } 

    @KafkaListener(topics="tacocloud.orders.topic")  // 1)
    public void handle(Order order){  // 2) í˜ì´ë¡œë“œì¸ Orderê°ì²´ë¥¼ handle()ì˜ ì¸ìë¡œ ë°›ëŠ”ë‹¤
        ui.displayOrder(order);
    }
}
```

1) tacocloud.orders.topicì´ë¼ëŠ” ì´ë¦„ì˜ í† í”½ì— ë©”ì‹œì§€ê°€ ë„ì°©í•  ë•Œ ìë™ í˜¸ì¶œë˜ì–´ì•¼ í•œë‹¤ëŠ” ê²ƒì„ ë‚˜íƒ€ë‚´ê¸° ìœ„í•´ handle()ë©”ì†Œë“œì—ëŠ” `@KafkaListener`ì• ë…¸í…Œì´ì…˜ì´ ì§€ì •ë˜ì—ˆë‹¤.

2) í˜ì´ë¡œë“œì¸ Orderê°ì²´ë§Œ handle()ì˜ ì¸ìë¡œ ë°›ì•˜ë‹¤.

ê·¸ëŸ¬ë‚˜ ë©”ì‹œì§€ì˜ ì¶”ê°€ì ì¸ **ë©”íƒ€ë°ì´í„°**ê°€ í•„ìš”í•˜ë‹¤ë©´ **ConsumerRecordë‚˜ Messageê°ì²´**ë„ ì¸ìë¡œ ë°›ì„ ìˆ˜ ìˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ ë‹¤ìŒì˜ handle()ë©”ì†Œë“œì—ì„œëŠ” ìˆ˜ì‹ ëœ ë©”ì‹œì§€ì˜ íŒŒí‹°ì…˜ê³¼ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ Loggingí•˜ê¸° ìœ„í•´ ConsumerRecordë¥¼ ì¸ìë¡œ ë°›ëŠ”ë‹¤

```java
@KafkaListener(topics="tacocloud.orders.topic")
public void handle(Order order, ConsumerRecord<Order> record){  // <= ConsumerRecord ê°ì²´
    log.info("Received from partition{} with timestamp{}", record.partition(), record.timestamp());
    // <= ë©”íƒ€ë°ì´í„°ì¸ Partitionê³¼ Timestamp ë¡œê¹…
    ui.displayOrder(order);
}
```

ì´ì™€ ìœ ì‚¬í•˜ê²Œ ConsumerRecord ëŒ€ì‹  Message ê°ì²´ë¥¼ ìš”ì²­í•˜ì—¬ ê°™ì€ ì¼ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

```java
@KafkaListener(topics="tacocloud.orders.topic")
public void handle(Order order, Message<Order> message){  // <= Message ê°ì²´
    MessageHeaders headers=message.getHeaders();
    log.info("Received from partition {} with timestamp {}" , 
        headers.get(KafkaHeaders.RECEIVED_PARTITION_ID)
        headers.get(KafkaHeaders.RECEIVED_TIMESTAMP)
    );
    ui.displayOrder(order);
}
```

ë©”ì‹œì§€ í˜ì´ë¡œë“œëŠ” ConsumerRecord.value()ë‚˜ Message.getPayload()ë¥¼ ì‚¬ìš©í•´ë„ ë°›ì„ ìˆ˜ ìˆë‹¤.

ì´ê²ƒì€ handle()ì˜ ë§¤ê°œë³€ìˆ˜ë¡œ ì§ì ‘ Order ê°ì²´ë¥¼ ìš”ì²­í•˜ëŠ” ëŒ€ì‹  `ConsumerRecord`ë‚˜ `Message` ê°ì²´ë¥¼ í†µí•´ Order ê°ì²´ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆìŒì„ ì˜ë¯¸í•œë‹¤.

# ğŸ“˜ 4. ë¹„ë™ê¸° ë©”ì‹œì§€ ì „ì†¡ê³¼ ìˆ˜ì‹  ê¸°ëŠ¥ì´ ì¶”ê°€ëœ íƒ€ì½” í´ë¼ìš°ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ë° ì‹¤í–‰í•˜ê¸°

---

```bash
# mavn Clean
./mvnw clean package

# Taco Cloud Application êµ¬ë™
java -jar tacos/target/taco-cloud-0.0.8-SNAPSHOT.jar

# Taco Cloud ì£¼ë°© Application êµ¬ë™
java -jar tacocloud-kitchen/target/tacocloud-kitchen-0.0.8-SNAPSHOT.jar
```

- Artemis ë¸Œë¡œì»¤ì™€ JmsTemplateì„ ì‚¬ìš©í•˜ì—¬ ì£¼ë¬¸ ë°ì´í„°ê°€ JMS ë©”ì‹œì§€ë¡œ ì²˜ë¦¬ë˜ì—ˆë‹¤.

